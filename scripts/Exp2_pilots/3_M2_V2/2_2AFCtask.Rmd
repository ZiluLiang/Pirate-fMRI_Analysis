---
title: "2_2AFCtask"
output: html_document
date: "2024-03-20"
---

```{r setup, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(error = FALSE,echo=FALSE, message=FALSE, warning=FALSE,fig.height = 5,fig.width = 8)

rm(list = ls())
project_dir = rstudioapi::getActiveProject();
src_dir = file.path(project_dir, "src/R", fsep="/")
llr_dir = file.path(project_dir, "src/LLR", fsep="/")

data_dir = file.path(project_dir, "data","Exp2_pilots","3_M2_v2", fsep="/")
result_dir = file.path(project_dir, "results","Exp2_pilots","3_M2_v2", fsep="/")

source(file.path(src_dir,"envSetup.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"funcDef.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"setPlotDefault.R",fsep="/"), local = knitr::knit_global())
#load(file.path(data_dir,"allexpdata_compo_lapse-0_01.RData"))
load(file.path(data_dir,"allexpdata_reclassify.RData"))
```

## Retrieve TS response location in the test block
```{r}
tstest_resp = filter(data_with_prob,session_str=="test (no feedback)")[c("subid","stim_id","resp_x","resp_y")]%>%
    change_cols_name(c("resp_x","resp_y"),c("stim_ts_resp_x","stim_ts_resp_y"))
fc_df_all = left_join(fc_df_all,tstest_resp,by=c("subid","stim_id"))%>%
  mutate(distractor_tsrespdist  = sqrt((distractor_x-stim_ts_resp_x)^2+(distractor_y-stim_ts_resp_y)^2),
         distractor_tsrespdistx = abs(distractor_x-stim_ts_resp_x),
         distractor_tsrespdisty = abs(distractor_y-stim_ts_resp_y),
         distractor_tsresprelx  = distractor_x-stim_ts_resp_x,
         distractor_tsresprely  = distractor_y-stim_ts_resp_y
         )%>%
  mutate(stim_type = stim_group)%>%
  mutate(distractor_distcb = (abs(distractor_relx)+abs(distractor_rely))*2)%>%
  mutate(distractor_distcbtype = factor(
    ifelse(distractor_distcb==1,"one-step",ifelse(distractor_distcb==2,"two-step",">3")),
    levels=c("one-step","two-step",">3")),
    stim_group = ifelse(expt_maptype=="cross maps",ifelse(stim_x*stim_y==0,"cross center","cross noncenter"),stim_type)
  )%>%
  mutate(
    stim_group = factor(stim_group,levels=c(1,2,3,"cross center","cross noncenter"),
                        labels=c("training","validation","test","cross center","cross noncenter")),
    distractor_istraining  = ifelse(xor(distractor_x==0,distractor_y==0),TRUE,FALSE),
    distractor_iscenter    = factor(ifelse(distractor_x*distractor_y==0,TRUE,FALSE),
                                    levels = c(TRUE,FALSE),labels=c("center","noncenter")))%>%
  mutate(
    # distractor_goal_samegroup = case_when(stim_type=="training"&distractor_istraining==TRUE ~ TRUE,
    #                                       stim_type=="training"&distractor_istraining==FALSE ~ FALSE,
    #                                       stim_type!="training"&distractor_istraining==TRUE ~ FALSE,
    #                                       stim_type!="training"&distractor_istraining==FALSE ~ TRUE,
    #                                   )
    distractor_goal_samegroup = iscenter==distractor_iscenter
  )%>%
  mutate(
    distractor_goal_samegroup = factor(distractor_goal_samegroup,levels = c(FALSE,TRUE),labels=c("different group","same group"))
  )

```


## missing trials
```{r}
fc_df_missedtrial_sub = fc_df_all%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("subid","expt_maptype","stim_group","session_str","expt_block"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","islearner","isgeneralizer","iscompositional"))%>%
  change_cols_name("mu_missed","missed")

fc_df_missedtrial_sumblock = fc_df_missedtrial_sub%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("islearner","isgeneralizer","expt_maptype","stim_group","session_str","expt_block"),
                           stats = c("mu","se"),
                           additionalvars = c("blocknumber_withinsess","islearner","isgeneralizer","iscompositional"))

ggplot(data=fc_df_missedtrial_sumblock,aes(x=blocknumber_withinsess,y=mu_missed,fill=stim_group,color=stim_group))+
  geom_point(data=fc_df_missedtrial_sub,aes(x=blocknumber_withinsess,y=missed),alpha = 0.3,size = 2,stroke=0)+
  geom_line()+
  geom_errorbar(aes(ymin=mu_missed-se_missed,
                    ymax=mu_missed+se_missed),
                width=0.4)+
  facet_nested(cols = vars(session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x")+
  scale_x_continuous(breaks = seq(1,12,1))+
  guides(fill = "none")+
  labs(x="block number",y="mean missed",color = "stim group",
       title = "# of missed trials")+
  theme(aspect.ratio = 6,legend.position = "top")

fc_df_missedtrial_sumexp = fc_df_missedtrial_sub%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("islearner","isgeneralizer","subid","stim_group"),
                           stats = c("mu"))

average_missed_percentage = sum(is.na(fc_df_all$resp_correct))/nrow(fc_df_all)
ggplot(data=fc_df_missedtrial_sumexp,aes(x=subid,y=mu_missed,fill=stim_group,color=stim_group))+
  geom_col(position=position_dodge2(1))+
  geom_hline(yintercept=average_missed_percentage,show.legend=FALSE)+
  geom_text(aes(color=NULL,fill=NULL,
                x=6.5, y= 0.2,
                label = sprintf("Average missed:  %.1f%s",average_missed_percentage*100,"%")),
            show.legend = FALSE)+
  scale_y_continuous(labels = function(x){sprintf("%.1f%s",x*100,"%")})+
  labs(y="percentage of missed trials in total (%)")+
  theme(axis.text.x = element_text(angle=90),aspect.ratio = 0.4)
  
fc_df = filter(fc_df_all,missed==0)


```


## Average Choice Accuracy and RT{.tabset}
```{r}
blockfcdata_sub = aggregate_data(fc_df,
                           yvars = c("resp_correct","resp_rt","distractor_dist"),
                           groupbyvars = c("subid","expt_maptype","stim_group","session_str","blocknumber_withinsess"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","islearner","isgeneralizer","iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_correct","mu_resp_rt","mu_distractor_dist"),
                   newnames = c("blockacc","blockrt","blockdist"))

blockfcdata_sum = aggregate_data(blockfcdata_sub,
                           yvars = c("blockacc","blockrt","blockdist"),
                           groupbyvars = c("session_str","expt_maptype","iscompositional","stim_group","blocknumber_withinsess"),
                           additionalvars = c("session_str","blocknumber_withinsess"),
                           stats = c("mu","se"))
```

### Accuracy

```{r,fig.width=5,fig.height=5}
(p=
   ggplot(data = blockfcdata_sum,
       aes(x=blocknumber_withinsess,y=mu_blockacc,color=stim_group))+
  facet_nested(rows=vars(iscompositional),
               cols=vars(expt_maptype),
               scales = "free_x",space = "free_x")+
  geom_errorbar(aes(ymin = mu_blockacc - se_blockacc,
                    ymax = mu_blockacc + se_blockacc),
                width=0.2,
                position = position_dodge(width=1))+
  geom_point(position = position_dodge(width=1),size=2)+ 
  geom_line(position = position_dodge(width=1),linewidth=0.8)+
  geom_line(data=blockfcdata_sub,
            aes(y=blockacc,group=interaction(stim_group, subid)),
            position=position_dodge(width=0.5),
            alpha = 0.5,linewidth=0.4)+
  geom_point(data=blockfcdata_sub,
             aes(y=blockacc,group=interaction(stim_group, subid)),
             alpha = 0.5,size = 0.8,stroke=0,
             position = position_dodge(width=0.5))+
   scale_x_continuous(breaks=seq(1,6))+
  labs(x="block number",y="block acc",color = "stim group",
       title = "Choice Accuracy")+
  guides(fill = "none")+
  theme(aspect.ratio = 4,legend.position = "top"))

ggsave(file.path(result_dir,paste0('blockacc_withsess','.png')),plot = p,device = 'png',width = 15,height = 7)
```
### checking the effect of Distance
```{r,fig.height=4}
blockfcdata_suballb = aggregate_data(fc_df,
                           yvars = c("resp_correct","resp_rt"),
                           groupbyvars = c("subid","distractor_distcbtype"),
                           stats = c("mu"),
                           additionalvars = c("iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_correct","mu_resp_rt"),
                   newnames = c("acc","rt"))

blockfcdata_sumallb = aggregate_data(blockfcdata_suballb,
                           yvars = c("acc","rt"),
                           groupbyvars = c("iscompositional","distractor_distcbtype"),
                           stats = c("mu","se"))
(p=
   ggplot(data = blockfcdata_sumallb,
       aes(x=distractor_distcbtype,y=mu_acc,color=distractor_distcbtype))+
  facet_nested(cols=vars(iscompositional),
               scales = "free_x",space = "free_x")+
  geom_line(data=blockfcdata_suballb,aes(x=distractor_distcbtype,y=acc,group=subid),
             alpha = 0.2,size = 0.5,color="black")+
  geom_col(position = position_dodge(width=1),fill=NA)+
  geom_errorbar(aes(ymin = mu_acc - se_acc,
                    ymax = mu_acc + se_acc),
                width=0.4,
                position = position_dodge(width=1))+
  labs(x="distractor cb dist",y="block acc",color = "distractor cb dist",
       title = "Choice Accuracy")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))
```


### Stats
```{r}
# set test as reference level for stim group
fc_df <- within(fc_df, stim_type <- relevel(stim_type, ref = "test"))
fc_df <- within(fc_df, istraining <- relevel(istraining, ref = "training"))
fc_df <- within(fc_df, iscenter <- relevel(iscenter, ref = "noncenter"))
fc_df <- within(fc_df, expt_maptype <- relevel(expt_maptype, ref = "training maps"))
# set non-generalizer as reference level for isgeneralizer
fc_df <- within(fc_df, isgeneralizer <- relevel(isgeneralizer, ref = "non-generalizer"))
fc_df <- within(fc_df, iscompositional <- relevel(iscompositional, ref = "non-compositional"))

```

```{r}
model_acc  = glmer(resp_correct~blocknumber_withinsess+iscompositional*iscenter+expt_maptype+distractor_tsrespdist + (iscenter|subid)+(distractor_tsrespdist|subid),
              data=fc_df,family = binomial) 
model_rt   = lmer(resp_rt~blocknumber_withinsess+iscompositional*iscenter+expt_maptype+distractor_tsrespdist + (iscenter|subid)+(distractor_tsrespdist|subid),
              data=filter(fc_df,resp_correct==TRUE))
#model_dist = lmer(distractor_dist~iscompositional+blocknumber_withinsess + (1 |subid),
#              data=fc_df)
export_summs(model_acc,model_rt,error_format = "(\u00B1{std.error})",error_pos ="same",
             model.names=c("Accuracy","RT"),
             coefs = c("block" = "blocknumber_withinsess",
                       "G>nG" = "iscompositionalcompositional",
                       "Cmap>Tmap"  = "expt_maptypecross maps",
                       "Center>nonCenter" = "iscentercenter",
                       "distractor distance to ts resploc"="distractor_tsrespdist",
                       "G>nG * Center>nonCenter"  = "iscompositionalcompositional:iscentercenter"))
```


## check map switch or group switch cost
```{r}
fc_df_switch = fc_df_all%>%
  group_by(subid,expt_block)%>%
  mutate(map_switch = factor(expt_map == lag(expt_map),levels=c(T,F),labels=c("switch map","same map")),
         maptype_switch = factor(expt_maptype == lag(expt_maptype),levels=c(T,F),labels=c("switch maptype","same maptype")),
         stimtype_switch = factor(istraining == lag(istraining),levels=c(T,F),labels=c("switch stimtype","same stimtype"))
         )%>%
  filter(expt_trial>min(expt_trial)&missed==0)
  
map_switch_sub = fc_df_switch%>%
  aggregate_data(groupbyvars = c("subid","iscenter","maptype_switch"),
                 yvars = c("resp_correct","resp_rt"),
                 additionalvars = "iscompositional",
                 stats = "mu")%>%
  change_cols_name(c("mu_resp_correct","mu_resp_rt"),c("accuracy","rt"))

map_switch_sum = map_switch_sub%>%
  aggregate_data(groupbyvars = c("iscompositional","iscenter","maptype_switch"),
                 yvars=c("accuracy","rt"),
                 stats=c("mu","se"))

ggplot(data=map_switch_sum,aes(x=iscenter,color=maptype_switch,group=maptype_switch))+
  facet_grid(col=vars(iscompositional))+
  geom_col(aes(y=mu_accuracy),
           fill=NA,
           position=position_dodge(1))+
  geom_errorbar(aes(ymin=mu_accuracy-se_accuracy,ymax=mu_accuracy+se_accuracy),
                position=position_dodge(1),width=0.4)+
  geom_point(data=map_switch_sub,aes(y=accuracy),position=position_dodge(1))

map_switch_sub = fc_df_switch%>%
  filter(resp_correct ==1&iscenter=="noncenter")%>%
  aggregate_data(groupbyvars = c("subid","maptype_switch"),
                 yvars = c("resp_rt"),
                 additionalvars = "iscompositional",
                 stats = "mu")%>%
  change_cols_name(c("mu_resp_rt"),c("rt"))

map_switch_sum = map_switch_sub%>%
  aggregate_data(groupbyvars = c("iscompositional","maptype_switch"),
                 yvars=c("rt"),
                 stats=c("mu","se"))

ggplot(data=map_switch_sum,aes(x=iscompositional,color=maptype_switch,group=maptype_switch))+
  geom_col(aes(y=mu_rt),
           fill=NA,
           position=position_dodge(1))+
  geom_errorbar(aes(ymin=mu_rt-se_rt,ymax=mu_rt+se_rt),
                position=position_dodge(1),width=0.4)+
  geom_point(data=map_switch_sub,aes(y=rt),position=position_dodge(1))

```










## Taking into account center vs non center
```{r,fig.width=12,fig.height=4}
blockfcdata_suballb = aggregate_data(fc_df,
                           yvars = c("resp_correct","resp_rt","distractor_dist"),
                           groupbyvars = c("subid","expt_maptype","stim_group","session_str"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_correct","mu_resp_rt","mu_distractor_dist"),
                   newnames = c("acc","rt","dist"))

blockfcdata_sumallb = aggregate_data(blockfcdata_suballb,
                           yvars = c("acc","rt","dist"),
                           groupbyvars = c("session_str","expt_maptype","iscompositional","stim_group"),
                           additionalvars = c("session_str","blocknumber_withinsess"),
                           stats = c("mu","se"))
(p=
   ggplot(data = blockfcdata_sumallb,
       aes(x=stim_group,y=mu_acc,color=expt_maptype))+
  facet_nested(cols=vars(iscompositional),
               scales = "free_x",space = "free_x")+
  geom_line(data=blockfcdata_suballb,aes(x=stim_group,y=acc,group=subid),
             alpha = 0.2,size = 0.5,color="black")+
  geom_col(position = position_dodge(width=1),fill=NA)+
  geom_errorbar(aes(ymin = mu_acc - se_acc,
                    ymax = mu_acc + se_acc),
                width=0.4,
                position = position_dodge(width=1))+
    scale_color_manual(values=twolevel_colors)+
  labs(x="stim group",y="Accuracy",color = "map type",
       title = "Choice Accuracy")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))
```
```{r,fig.height=4,fig.width=14}
blockfcdata_suballb = aggregate_data(fc_df%>%filter(resp_correct == TRUE),
                           yvars = c("resp_rt"),
                           groupbyvars = c("subid","expt_maptype","stim_group","session_str"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_rt"),
                   newnames = c("rt"))

blockfcdata_sumallb = aggregate_data(blockfcdata_suballb,
                           yvars = c("rt"),
                           groupbyvars = c("session_str","expt_maptype","iscompositional","stim_group"),
                           additionalvars = c("session_str","blocknumber_withinsess"),
                           stats = c("mu","se"))

(p=
   ggplot(data = blockfcdata_sumallb,
       aes(x=stim_group,y=mu_rt,color=expt_maptype))+
  facet_nested(cols=vars(iscompositional),
               scales = "free_x",space = "free_x")+
  geom_line(data=blockfcdata_suballb,aes(x=stim_group,y=rt,group=subid),
             alpha = 0.2,size = 0.5,color="black")+
  geom_col(position = position_dodge(width=1),fill=NA)+
  geom_errorbar(aes(ymin = mu_rt - se_rt,
                    ymax = mu_rt + se_rt),
                width=0.4,
                position = position_dodge(width=1))+
    scale_color_manual(values=twolevel_colors)+
  labs(x="stim group",y="average RT",color = "map type",
       title = "Choice RT")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))
```
 
```{r}
blockfcdata_suballb = aggregate_data(fc_df,
                           yvars = c("resp_correct","resp_rt","distractor_dist"),
                           groupbyvars = c("subid","iscenter","session_str"),
                           stats = c("mu"),
                           additionalvars = c("session_str","iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_correct","mu_resp_rt","mu_distractor_dist"),
                   newnames = c("acc","rt","dist"))

blockfcdata_sumallb = aggregate_data(blockfcdata_suballb,
                           yvars = c("acc","rt","dist"),
                           groupbyvars = c("session_str","iscompositional","iscenter"),
                           stats = c("mu","se"))
(p=
   ggplot(data = blockfcdata_sumallb,
       aes(x=iscenter,y=mu_acc,color=iscenter))+
  facet_nested(cols=vars(iscompositional),
               scales = "free_x",space = "free_x")+
  geom_line(data=blockfcdata_suballb,aes(x=iscenter,y=acc,group=subid),
             alpha = 0.2,size = 0.5,color="black")+
  geom_col(position = position_dodge(width=1),fill=NA)+
  geom_errorbar(aes(ymin = mu_acc - se_acc,
                    ymax = mu_acc + se_acc),
                width=0.4,
                position = position_dodge(width=1))+
    scale_color_manual(values=twolevel_colors)+
  labs(x="iscenter",y="Accuracy",color = "map type",
       title = "Choice Accuracy")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))

blockfcdata_suballb = aggregate_data(fc_df%>%filter(resp_correct == TRUE),
                           yvars = c("resp_rt"),
                           groupbyvars = c("subid","iscenter","session_str"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","iscompositional"))%>%
  change_cols_name(oldnames = c("mu_resp_rt"),
                   newnames = c("rt"))

blockfcdata_sumallb = aggregate_data(blockfcdata_suballb,
                           yvars = c("rt"),
                           groupbyvars = c("session_str","iscompositional","iscenter"),
                           additionalvars = c("session_str","blocknumber_withinsess"),
                           stats = c("mu","se"))

(p=
   ggplot(data = blockfcdata_sumallb,
       aes(x=iscenter,y=mu_rt,color=iscenter))+
  facet_nested(cols=vars(iscompositional),
               scales = "free_x",space = "free_x")+
  geom_line(data=blockfcdata_suballb,aes(x=iscenter,y=rt,group=subid),
             alpha = 0.2,size = 0.5,color="black")+
  geom_col(position = position_dodge(width=1),fill=NA)+
  geom_errorbar(aes(ymin = mu_rt - se_rt,
                    ymax = mu_rt + se_rt),
                width=0.4,
                position = position_dodge(width=1))+
    scale_color_manual(values=twolevel_colors)+
  labs(x="stim group",y="average RT",color = "stim type",
       title = "Choice RT")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))
```
 
```{r}
model_rt   = lmer(rt~iscompositional+iscompositional*iscenter + (1|subid),
              data=blockfcdata_suballb)
#model_dist = lmer(distractor_dist~iscompositional+blocknumber_withinsess + (1 |subid),
#              data=fc_df)
export_summs(model_rt,error_format = "(\u00B1{std.error})",error_pos ="same",
             model.names=c("RT"),
             coefs = c(#"block" = "blocknumber_withinsess",
                       "G>nG" = "iscompositionalcompositional",
                       "Center>nonCenter" = "iscentercenter",
                       "G>nG * Center>nonCenter"  = "iscompositionalcompositional:iscentercenter"))
```
 
 
## taking into account distractor location

```{r,fig.width=8,fig.height=5}
subsum2AFC_test = fc_df%>%
  mutate(stim_mapandgroup = paste0(expt_maptype,"\n",iscenter))%>%
    aggregate_data(groupbyvars = c("subid","stim_mapandgroup","distractor_goal_samegroup"),
                   yvars = c("resp_correct"),
                   stats =c("mu"),
                   additionalvars = c("iscompositional","expt_maptype"))%>%
    change_cols_name(oldnames = "mu_resp_correct","accuracy")

groupsum2AFC_test = subsum2AFC_test%>%
  aggregate_data(groupbyvars = c("iscompositional","stim_mapandgroup","distractor_goal_samegroup"),
                 yvars = c("accuracy"),
                 stats =c("mu","se"),
                 additionalvars = c("expt_maptype"))

ggplot(data=groupsum2AFC_test,
       aes(x=stim_mapandgroup,y=mu_accuracy,color=distractor_goal_samegroup))+
  facet_nested(cols=vars(iscompositional))+
  geom_col(position=position_dodge(1),fill=NA)+
  geom_errorbar(aes(ymin=mu_accuracy-se_accuracy,
                    ymax=mu_accuracy+se_accuracy),
                width=0.4,
                position=position_dodge(1))+
  geom_point(data=subsum2AFC_test,
       aes(x=stim_mapandgroup,y=accuracy),
       size=2,alpha=0.8,
       position=position_dodge(1))+
  theme(legend.position = "top",legend.direction = "horizontal")#+
  #geom_line(data=subsum2AFC_test,
  #     aes(x=stim_mapandgroup,y=accuracy,group=interaction(distractor_goal_samegroup,subid)),
  #     position=position_dodge(1),
  #     size=0.5,alpha=0.5)
```


## ERROR PATTERN{.tabset}

```{r}
fc_df = fc_df %>%
  mutate(choosen_locid = if_else(resp_correct==1,stim_locid,distractor_locid))


```


### Location of errors
At which locations, do participants make more mistakes?

```{r}
fcdf_sumloc = fc_df%>%
    aggregate_data(groupbyvars = c("subid","stim_id"),
                   yvars = c("resp_correct"),
                   stats =c("mu"),
                   additionalvars = c("iscompositional","islearner","expt_map","stim_x","stim_y"))%>%
    change_cols_name(oldnames = "mu_resp_correct","accuracy")%>%
  mutate(expt_map = factor(expt_map,levels = c(0,1,2,3),labels=c("training map 1\n(x1y1)","training map 2\n(x2y2)",
                                                                 "cross map 2\n(x1y2)","cross map 2\n(x2y1)")))
ggplot(fcdf_sumloc,aes(x=stim_x,y=stim_y,fill=accuracy))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_fill_continuous_divergingx (palette = "RdYlBu",mid =0.5,rev=TRUE)+
  facet_nested(cols=vars(iscompositional,subid),rows=vars(expt_map))+
  theme(legend.position = "top",legend.direction = "horizontal",legend.key.width = unit(dev.size()[1] / 10, "inches"))
```

What if we exclude trials where distractor is from different stim group
```{r}

fcdf_sumloc = fc_df%>%
  filter(distractor_iscenter==FALSE & stim_x*stim_y!=0)%>%
    aggregate_data(groupbyvars = c("subid","stim_id"),
                   yvars = c("resp_correct"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner","expt_map","stim_x","stim_y"))%>%
    change_cols_name(oldnames = "mu_resp_correct","accuracy")%>%
  mutate(expt_map = factor(expt_map,levels = c(0,1,2,3),labels=c("training map 1\n(x1y1)","training map 2\n(x2y2)",
                                                                 "cross map 2\n(x1y2)","cross map 2\n(x2y1)")))
ggplot(fcdf_sumloc,aes(x=stim_x,y=stim_y,fill=accuracy))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_fill_continuous_divergingx (palette = "RdYlBu",mid =0.5,rev=TRUE)+
  facet_nested(cols=vars(islearner,isgeneralizer,subid),rows=vars(expt_map))+
  theme(legend.position = "top",legend.direction = "horizontal",legend.key.width = unit(dev.size()[1] / 10, "inches"))
```



### Relative location of errors
plot each participants error location with respect to the correct location. Are they more likely to make an error when it is within the same row/col? etc

First we plot the totoal number of errors at each relative location
```{r}
fcdf_relloc_nerr = fc_df%>%
  filter(resp_correct==0)%>%
    aggregate_data(groupbyvars = c("subid","stim_id","distractor_relx","distractor_rely"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining"))%>%
    change_cols_name(oldnames = "n_expt_index","n_errors")%>%
  aggregate_data(groupbyvars = c("subid","istraining","distractor_relx","distractor_rely"),
                   yvars = c("n_errors"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner"))
ggplot(fcdf_relloc_nerr,aes(x=distractor_relx,y=distractor_rely,fill=n_n_errors))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("fill"))+
  #scale_linewidth_manual(values=c(1,0))+
  facet_nested(rows = vars(istraining),cols=vars(islearner,isgeneralizer,subid))+
  theme(legend.position = "top",legend.direction = "horizontal")
```

Then we plot the percentage of errors at each relative location:
```{r}
fcdf_relloc_perr = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials have response
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_withresp=n())%>%
  ungroup()%>%
  ### calculate the number of errors for each participant, at each stimuli 
  filter(resp_correct==0)%>%
  group_by(subid,stim_id)%>%
  mutate(n_total2afcerr=n())%>%
  ungroup()%>%
  
  ### calculate the percentange of errors for each stimuli at different relative locations 
    aggregate_data(groupbyvars = c("subid","stim_id","distractor_relx","distractor_rely"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("iscompositional","istraining","n_2afctrials_withresp","n_total2afcerr"))%>%
    change_cols_name(oldnames = "n_expt_index","n_errors")%>%
    mutate(p_error = n_errors/n_total2afcerr)%>%
  
  ### calculate the average percentage of errors at different relative locations for different  stimuli type: training vs validation
  aggregate_data(groupbyvars = c("subid","istraining","distractor_relx","distractor_rely"),
                   yvars = c("p_error"),
                   stats =c("mu"),
                   additionalvars = c("iscompositional"))
ggplot(fcdf_relloc_perr,aes(x=distractor_relx,y=distractor_rely,fill=mu_p_error))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("colour", "fill"))+
  #scale_linewidth_manual(values=c(1,0))+
  facet_nested(rows = vars(istraining),cols=vars(iscompositional,subid))+
  theme(legend.position = "top",legend.direction = "horizontal",legend.key.width = unit(dev.size()[1] / 10, "inches"))
```


### x confusion matrix when distractor is from same row  and y confusion matrix when distractor is from same column
```{r}
fcdf_sumlocx = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials where distractor and goal have same y and participant responded
  filter(stim_y == distractor_y)%>%
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_sameywithresp=n())%>%
  ungroup()%>%
  
  ## calculate for each participant, at each stim, what is the proportion of trials that chose an option with x=-1,-.5,... etc
    aggregate_data(groupbyvars = c("subid","stim_id","choosen_x"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining","stim_x","n_2afctrials_sameywithresp"))%>%
    change_cols_name(oldnames = "n_expt_index","n_trials_choosex")%>%
  mutate(p_trials_choosex = n_trials_choosex/n_2afctrials_sameywithresp)%>%
  
  ## calcuate for each participant, at each stim_x, what is the average proportion of trials that chose an option with x=-1,-.5,... etc
  aggregate_data(groupbyvars = c("subid","istraining","stim_x","choosen_x"),
                   yvars = c("p_trials_choosex"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  change_cols_name(oldnames = c("mu_p_trials_choosex","stim_x","choosen_x"),
                   newnames = c("mu_p_trials","stim_loc","choosen_loc"))%>%
  mutate(confusionmatforaxis="x")

fcdf_sumlocy = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials where distractor and goal have same x and participant responded
  filter(stim_x == distractor_x)%>%
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_samexwithresp=n())%>%
  ungroup()%>%
  
  ## calculate for each participant, at each stim, what is the proportion of trials that chose an option with y=-1,-.5,... etc
    aggregate_data(groupbyvars = c("subid","stim_id","choosen_y"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining","stim_y","n_2afctrials_samexwithresp"))%>%
    change_cols_name(oldnames = "n_expt_index","n_trials_choosey")%>%
  mutate(p_trials_choosey = n_trials_choosey/n_2afctrials_samexwithresp)%>%
  ## calcuate for each participant, at each stim_x, what is the average proportion of trials that chose an option with x=-1,-.5,... etc
  aggregate_data(groupbyvars = c("subid","istraining","stim_y","choosen_y"),
                   yvars = c("p_trials_choosey"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  change_cols_name(oldnames = c("mu_p_trials_choosey","stim_y","choosen_y"),
                   newnames = c("mu_p_trials","stim_loc","choosen_loc"))%>%
  mutate(confusionmatforaxis="y")
  
fcdf_sumloc = rbind(fcdf_sumlocx,fcdf_sumlocy)

ggplot(fcdf_sumloc,aes(x=stim_loc,y=choosen_loc,fill=mu_p_trials))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("fill"))+
  scale_y_continuous(trans="reverse")+
  facet_nested(rows = vars(confusionmatforaxis,istraining),cols=vars(islearner,isgeneralizer,subid))+
  theme(legend.position = "top",legend.direction = "horizontal")
```

### quadrant error: two-step away but cross column and row trials (exclude training and corner stimuli)
```{r,fig.height = 4}
fcdf_quaderr = fc_df%>%
  ## select two-step away trials for non-training stimuli and non-corner stimuli
  filter(istraining=="validation+test" & abs(stim_x*stim_y)<1 & distractor_distx==0.5 & distractor_disty==0.5)
# to check if selection if correct: ggplot(data=fcdf_quaderr,aes(x=stim_x,y=stim_y,fill=subid,color=subid))+geom_point()+facet_nested(cols=vars(subid))+theme(legend.position="top")

fcdf_quaderr = fcdf_quaderr%>%
  group_by(subid)%>%
  mutate(n_selectedtrials=n())%>%
  ungroup()%>%
  mutate(distractor_samexsign = sign(distractor_x) == sign(stim_x),
         distractor_sameysign = sign(distractor_y) == sign(stim_y))%>%
  mutate(distractor_samequadrant = distractor_samexsign&distractor_sameysign)%>%
  mutate(distractor_samexsign = factor(distractor_samexsign, levels=c(TRUE,FALSE), labels=c("same x sign","different x sign")),
         distractor_sameysign = factor(distractor_sameysign, levels=c(TRUE,FALSE), labels=c("same y sign","different y sign")),
         distractor_samequadrant = factor(distractor_samequadrant, levels=c(TRUE,FALSE), labels=c("same quadrant","different quadrant"))
         )

fcdf_quaderr_sub = fcdf_quaderr%>%
  aggregate_data(groupbyvars = c("subid","distractor_samequadrant"),
                 yvars = c("resp_correct","resp_rt"),
                 stats="mu",
                 additionalvars = c("iscompositional"))%>%
  change_cols_name(c("mu_resp_correct","mu_resp_rt"),c("accuracy","RT"))

fcdf_quaderr_sum = fcdf_quaderr_sub%>%
  aggregate_data(groupbyvars = c("iscompositional","distractor_samequadrant"),
                 yvars = c("accuracy","RT"),
                 stats=c("mu","se"))

ggplot(data=fcdf_quaderr_sum,aes(x=distractor_samequadrant,fill=distractor_samequadrant,color=distractor_samequadrant))+
  geom_col(aes(y=mu_accuracy),position = position_dodge2(1),alpha=0.5)+
  geom_errorbar(aes(ymin=mu_accuracy-se_accuracy,
                    ymax=mu_accuracy+se_accuracy),
                position = position_dodge(1),width=0.4)+
  geom_point(data=fcdf_quaderr_sub,aes(y=accuracy),position = position_dodge(1))+
  geom_line(data=fcdf_quaderr_sub,aes(y=accuracy,group=subid))+
  facet_nested(cols = vars(iscompositional))+
  theme(legend.direction = "horizontal",legend.position = "top",aspect.ratio = 1.8)

ggplot(data=fcdf_quaderr_sum,aes(x=distractor_samequadrant,fill=distractor_samequadrant,color=distractor_samequadrant))+
  geom_col(aes(y=mu_RT),position = position_dodge2(1),alpha=0.5)+
  geom_errorbar(aes(ymin=mu_RT-se_RT,
                    ymax=mu_RT+se_RT),
                position = position_dodge(1),width=0.4)+
  geom_point(data=fcdf_quaderr_sub,aes(y=RT),position = position_dodge(1))+
  geom_line(data=fcdf_quaderr_sub,aes(y=RT,group=subid))+
  facet_nested(cols = vars(iscompositional))+
  theme(legend.direction = "horizontal",legend.position = "top",aspect.ratio = 1.8)

```

