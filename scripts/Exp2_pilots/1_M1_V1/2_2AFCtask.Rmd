---
title: "2_2AFCtask"
output: html_document
date: "2024-03-20"
---

```{r setup, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(error = FALSE,echo=FALSE, message=FALSE, warning=FALSE,fig.height = 9,fig.width = 16)

rm(list = ls())
project_dir = rstudioapi::getActiveProject();
src_dir = file.path(project_dir, "src/R", fsep="/")
llr_dir = file.path(project_dir, "src/LLR", fsep="/")

data_dir = file.path(project_dir, "data","Exp2_pilots","1_M1_v1", fsep="/")
result_dir = file.path(project_dir, "results","Exp2_pilots","1_M1_v1", fsep="/")


source(file.path(src_dir,"envSetup.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"funcDef.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"setPlotDefault.R",fsep="/"), local = knitr::knit_global())
load(file.path(data_dir,"allexpdata_compo_lapse-0_01.RData"))
```


```{r}

fc_df_missedtrial_sub = fc_df_all%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("subid","stim_group","expt_session","expt_block"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","islearner","isgeneralizer"))%>%
  change_cols_name("mu_missed","missed")

fc_df_missedtrial_sumblock = fc_df_missedtrial_sub%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("islearner","isgeneralizer","stim_group","expt_session","expt_block"),
                           stats = c("mu","se"),
                           additionalvars = c("blocknumber_withinsess","session_str","islearner","isgeneralizer"))

ggplot(data=fc_df_missedtrial_sumblock,aes(x=blocknumber_withinsess,y=mu_missed,fill=stim_group,color=stim_group))+
  geom_point(data=fc_df_missedtrial_sub,aes(x=blocknumber_withinsess,y=missed),alpha = 0.3,size = 2,stroke=0)+
  geom_line()+
  geom_errorbar(aes(ymin=mu_missed-se_missed,
                    ymax=mu_missed+se_missed),
                width=0.4)+
  facet_nested(cols = vars(session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x")+
  scale_x_continuous(breaks = seq(1,12,1))+
  guides(fill = "none")+
  labs(x="block number",y="mean missed",color = "stim group",
       title = "# of missed trials")+
  theme(aspect.ratio = 8,legend.position = "top")

fc_df_missedtrial_sumexp = fc_df_missedtrial_sub%>%
  aggregate_data(yvars = c("missed"),
                 groupbyvars = c("islearner","isgeneralizer","subid","stim_group"),
                           stats = c("mu"))

average_missed_percentage = sum(is.na(fc_df_all$resp_correct))/nrow(fc_df_all)
ggplot(data=fc_df_missedtrial_sumexp,aes(x=subid,y=mu_missed,fill=stim_group,color=stim_group))+
  geom_col(position=position_dodge2(1))+
  geom_hline(yintercept=average_missed_percentage,show.legend=FALSE)+
  geom_text(aes(color=NULL,fill=NULL,
                x=3.5, y= 0.2,
                label = sprintf("Average missed:  %.1f%s",average_missed_percentage*100,"%")),
            show.legend = FALSE)+
  scale_y_continuous(labels = function(x){sprintf("%.1f%s",x*100,"%")})+
  labs(y="percentage of missed trials in total (%)")+
  theme(axis.text.x = element_text(angle=90))
  
fc_df = filter(fc_df_all,missed==0)

```


## Choice Accuracy and RT{.tabset}
```{r}
blockfcdata_sub = aggregate_data(fc_df,
                           yvars = c("resp_correct","resp_rt","distractor_dist"),
                           groupbyvars = c("subid","stim_group","expt_session","expt_block"),
                           stats = c("mu"),
                           additionalvars = c("blocknumber_withinsess","session_str","islearner","isgeneralizer"))%>%
  change_cols_name(oldnames = c("mu_resp_correct","mu_resp_rt","mu_distractor_dist"),
                   newnames = c("blockacc","blockrt","blockdist"))%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))

blockfcdata_sum = aggregate_data(blockfcdata_sub,
                           yvars = c("blockacc","blockrt","blockdist"),
                           groupbyvars = c("expt_session","islearner","isgeneralizer","stim_group","expt_block"),
                           additionalvars = c("session_str","blocknumber_withinsess"),
                           stats = c("mu","se"))
```

### Accuracy
```{r}
(p=
   ggplot(data = blockfcdata_sum,
       aes(x=blocknumber_withinsess,y=mu_blockacc,fill=stim_group,color=stim_group))+
  facet_nested(rows=vars(islearner,isgeneralizer),scales = "free_x",space = "free_x")+
  geom_errorbar(aes(ymin = mu_blockacc - se_blockacc,
                    ymax = mu_blockacc + se_blockacc),
                width=0.4,
                position = position_dodge(width=0.5))+
  geom_point(position = position_dodge(width=0.5))+ 
  geom_line(position = position_dodge(width=0.5))+
  geom_point(data=blockfcdata_sub,aes(x=blocknumber_withinsess,y=blockacc),
             alpha = 0.3,size = 2,stroke=0,
             position = position_dodge(width=0.5))+
  labs(x="block number",y="block acc",color = "stim group",
       title = "Choice Accuracy")+
  guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))

ggsave(file.path(result_dir,paste0('blockacc_withsess','.png')),plot = p,device = 'png',width = 15,height = 7)
```

### RT

```{r}
(p=
   ggplot(data = blockfcdata_sum,
       aes(x=blocknumber_withinsess,y=mu_blockrt,fill=stim_group,color=stim_group))+
  facet_nested(rows=vars(islearner,isgeneralizer),scales = "free_x",space = "free_x")+
  geom_errorbar(aes(ymin = mu_blockrt - se_blockrt,
                    ymax = mu_blockrt + se_blockrt),
                width=0.4,
                position = position_dodge(width=0.5))+
  geom_point(position = position_dodge(width=0.5))+ 
  geom_line(position = position_dodge(width=0.5))+
  geom_point(data=blockfcdata_sub,aes(x=blocknumber_withinsess,y=blockrt,group=subid),
             alpha = 0.3,size = 2,stroke=0,
             position = position_dodge(width=0.5))+
  scale_y_continuous(breaks=c(0,200,400,600,800,1000))+
  labs(x="block number",y="block rt (ms)",color = "stim group",
       title = "Choice RT")+
   guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))

ggsave(file.path(result_dir,paste0('blockrt_withsess','.png')),plot = p,device = 'png',width = 15,height = 7)
```

### Block difficulty
```{r}
(p=
   ggplot(data = blockfcdata_sum,
       aes(x=blocknumber_withinsess,y=mu_blockdist,fill=stim_group,color=stim_group))+
  facet_nested(rows=vars(islearner,isgeneralizer),scales = "free_x",space = "free_x")+
  geom_errorbar(aes(ymin = mu_blockdist - se_blockdist,
                    ymax = mu_blockdist + se_blockdist),
                width=0.4,
                position = position_dodge(width=0.5))+
  geom_point(position = position_dodge(width=0.5))+ 
  geom_line(position = position_dodge(width=0.5))+
  geom_point(data=blockfcdata_sub,aes(x=blocknumber_withinsess,y=blockdist,group=subid),
             alpha = 0.3,size = 2,stroke=0,
             position = position_dodge(width=0.5))+
  labs(x="block number",y="block dist",color = "stim group",
       title = "Block difficulty level (average distractor distance to goal)")+
   guides(fill = "none")+
  theme(aspect.ratio = 5,legend.position = "top"))

ggsave(file.path(result_dir,paste0('blockdist_withsess','.png')),plot = p,device = 'png',width = 15,height = 7)
```

### Stats
```{r}
# set test as reference level for stim group
fc_df <- within(fc_df, stim_group <- relevel(stim_group, ref = "test"))
# set test as reference level for isgeneralizer
fc_df$isgeneralizer = factor(fc_df$isgeneralizer,levels=c(0,1),labels=c("nonGeneralizer","Generalizer"))
fc_df <- within(fc_df, isgeneralizer <- relevel(isgeneralizer, ref = "nonGeneralizer"))
```

```{r}
model_acc  = glmer(resp_correct~isgeneralizer*distractor_dist+isgeneralizer*stim_group+blocknumber_withinsess + (1 |subid),
              data=fc_df,family = binomial)
model_rt   = lmer(resp_rt~isgeneralizer*distractor_dist+isgeneralizer*stim_group+blocknumber_withinsess + (1 |subid),
              data=fc_df)
model_dist = lmer(distractor_dist~isgeneralizer+blocknumber_withinsess + (1 |subid),
              data=fc_df)
export_summs(model_acc,model_rt,model_dist,error_format = "[{conf.low}, {conf.high}]",
             model.names=c("Accuracy","RT","Difficulty"))
```

## ERROR PATTERN{.tabset}

```{r}
fc_df = fc_df %>%
  mutate(choosen_locid = if_else(resp_correct==1,stim_locid,distractor_locid))


```


### Location of errors
At which locations, do participants make more mistakes?

```{r}

#fcdf.similarity.perblock = generate_RDM(fc_df, splitby_var=c("subid","blocknumber_withinsess","istraining"), 
#             sortby_var=c("stim_x","stim_y"), 
#             similarity_var=c("choosen_locid","stim_locid"), 
#             specs_var=c("subid","isgeneralizer","islearner","blocknumber_withinsess","istraining"))

fcdf_sumloc = fc_df%>%
    aggregate_data(groupbyvars = c("subid","stim_id"),
                   yvars = c("resp_correct"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner","istraining","stim_x","stim_y"))%>%
    change_cols_name(oldnames = "mu_resp_correct","accuracy")%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
ggplot(fcdf_sumloc,aes(x=stim_x,y=stim_y,fill=accuracy))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("fill"))+
  facet_nested(cols=vars(islearner,isgeneralizer,subid),rows=vars(istraining))+
  theme(legend.position = "top",legend.direction = "horizontal",legend.key.width = unit(dev.size()[1] / 10, "inches"))
```


### Relative location of errors
plot each participants error location with respect to the correct location. Are they more likely to make an error when it is within the same row/col? etc

First we plot the totoal number of errors at each relative location
```{r}
fcdf_relloc_nerr = fc_df%>%
  filter(resp_correct==0)%>%
    aggregate_data(groupbyvars = c("subid","stim_id","distractor_relx","distractor_rely"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining"))%>%
    change_cols_name(oldnames = "n_expt_index","n_errors")%>%
  aggregate_data(groupbyvars = c("subid","istraining","distractor_relx","distractor_rely"),
                   yvars = c("n_errors"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
ggplot(fcdf_relloc_nerr,aes(x=distractor_relx,y=distractor_rely,fill=n_n_errors))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("fill"))+
  #scale_linewidth_manual(values=c(1,0))+
  facet_nested(rows = vars(istraining),cols=vars(islearner,isgeneralizer,subid))+
  theme(legend.position = "top",legend.direction = "horizontal")
```

Then we plot the percentage of errors at each relative location:
```{r}
fcdf_relloc_perr = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials have response
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_withresp=n())%>%
  ungroup()%>%
  ### calculate the number of errors for each participant, at each stimuli 
  filter(resp_correct==0)%>%
  group_by(subid,stim_id)%>%
  mutate(n_total2afcerr=n())%>%
  ungroup()%>%
  
  ### calculate the percentange of errors for each stimuli at different relative locations 
    aggregate_data(groupbyvars = c("subid","stim_id","distractor_relx","distractor_rely"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining","n_2afctrials_withresp","n_total2afcerr"))%>%
    change_cols_name(oldnames = "n_expt_index","n_errors")%>%
    mutate(p_error = n_errors/n_total2afcerr)%>%
  
  ### calculate the average percentage of errors at different relative locations for different  stimuli type: training vs validation
  aggregate_data(groupbyvars = c("subid","istraining","distractor_relx","distractor_rely"),
                   yvars = c("p_error"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
ggplot(fcdf_relloc_perr,aes(x=distractor_relx,y=distractor_rely,fill=mu_p_error))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("colour", "fill"))+
  #scale_linewidth_manual(values=c(1,0))+
  facet_nested(rows = vars(istraining),cols=vars(islearner,isgeneralizer,subid))+
  theme(legend.position = "top",legend.direction = "horizontal",legend.key.width = unit(dev.size()[1] / 10, "inches"))
```


### x confusion matrix when distractor is from same row  and y confusion matrix when distractor is from same column
```{r}
fcdf_sumlocx = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials where distractor and goal have same y and participant responded
  filter(stim_y == distractor_y)%>%
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_sameywithresp=n())%>%
  ungroup()%>%
  
  ## calculate for each participant, at each stim, what is the proportion of trials that chose an option with x=-1,-.5,... etc
    aggregate_data(groupbyvars = c("subid","stim_id","choosen_x"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining","stim_x","n_2afctrials_sameywithresp"))%>%
    change_cols_name(oldnames = "n_expt_index","n_trials_choosex")%>%
  mutate(p_trials_choosex = n_trials_choosex/n_2afctrials_sameywithresp)%>%
  
  ## calcuate for each participant, at each stim_x, what is the average proportion of trials that chose an option with x=-1,-.5,... etc
  aggregate_data(groupbyvars = c("subid","istraining","stim_x","choosen_x"),
                   yvars = c("p_trials_choosex"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  change_cols_name(oldnames = c("mu_p_trials_choosex","stim_x","choosen_x"),
                   newnames = c("mu_p_trials","stim_loc","choosen_loc"))%>%
  mutate(confusionmatforaxis="x")

fcdf_sumlocy = fc_df%>%
  ## calculate for each participant, at each stimuli, how many trials where distractor and goal have same x and participant responded
  filter(stim_x == distractor_x)%>%
  group_by(subid,stim_id)%>%
  mutate(n_2afctrials_samexwithresp=n())%>%
  ungroup()%>%
  
  ## calculate for each participant, at each stim, what is the proportion of trials that chose an option with y=-1,-.5,... etc
    aggregate_data(groupbyvars = c("subid","stim_id","choosen_y"),
                   yvars = c("expt_index"),
                   stats =c("n"),
                   additionalvars = c("isgeneralizer","islearner","istraining","stim_y","n_2afctrials_samexwithresp"))%>%
    change_cols_name(oldnames = "n_expt_index","n_trials_choosey")%>%
  mutate(p_trials_choosey = n_trials_choosey/n_2afctrials_samexwithresp)%>%
  ## calcuate for each participant, at each stim_x, what is the average proportion of trials that chose an option with x=-1,-.5,... etc
  aggregate_data(groupbyvars = c("subid","istraining","stim_y","choosen_y"),
                   yvars = c("p_trials_choosey"),
                   stats =c("mu"),
                   additionalvars = c("isgeneralizer","islearner"))%>%
  change_cols_name(oldnames = c("mu_p_trials_choosey","stim_y","choosen_y"),
                   newnames = c("mu_p_trials","stim_loc","choosen_loc"))%>%
  mutate(confusionmatforaxis="y")
  
fcdf_sumloc = rbind(fcdf_sumlocx,fcdf_sumlocy)%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))

ggplot(fcdf_sumloc,aes(x=stim_loc,y=choosen_loc,fill=mu_p_trials))+
    geom_tile(linewidth=0.8,width=0.4,height=0.4)+
  scale_colour_viridis_c(aesthetics = c("fill"))+
  scale_y_continuous(trans="reverse")+
  facet_nested(rows = vars(confusionmatforaxis,istraining),cols=vars(islearner,isgeneralizer,subid))+
  theme(legend.position = "top",legend.direction = "horizontal")
```

### quadrant error: two-step away but cross column and row trials (exclude training and corner stimuli)
```{r,fig.height = 4}
fcdf_quaderr = fc_df%>%
  ## select two-step away trials for non-training stimuli and non-corner stimuli
  filter(istraining=="validation+test" & abs(stim_x*stim_y)<1 & distractor_distx==0.5 & distractor_disty==0.5)
# to check if selection if correct: ggplot(data=fcdf_quaderr,aes(x=stim_x,y=stim_y,fill=subid,color=subid))+geom_point()+facet_nested(cols=vars(subid))+theme(legend.position="top")

fcdf_quaderr = fcdf_quaderr%>%
  group_by(subid)%>%
  mutate(n_selectedtrials=n())%>%
  ungroup()%>%
  mutate(distractor_samexsign = sign(distractor_x) == sign(stim_x),
         distractor_sameysign = sign(distractor_y) == sign(stim_y))%>%
  mutate(distractor_samequadrant = distractor_samexsign&distractor_sameysign)%>%
  mutate(distractor_samexsign = factor(distractor_samexsign, levels=c(TRUE,FALSE), labels=c("same x sign","different x sign")),
         distractor_sameysign = factor(distractor_sameysign, levels=c(TRUE,FALSE), labels=c("same y sign","different y sign")),
         distractor_samequadrant = factor(distractor_samequadrant, levels=c(TRUE,FALSE), labels=c("same quadrant","different quadrant"))
         )

fcdf_quaderr_sub = fcdf_quaderr%>%
  aggregate_data(groupbyvars = c("subid","distractor_samequadrant"),
                 yvars = c("resp_correct","resp_rt"),
                 stats="mu",
                 additionalvars = c("islearner","isgeneralizer"))%>%
  change_cols_name(c("mu_resp_correct","mu_resp_rt"),c("accuracy","RT"))

fcdf_quaderr_sum = fcdf_quaderr_sub%>%
  aggregate_data(groupbyvars = c("islearner","isgeneralizer","distractor_samequadrant"),
                 yvars = c("accuracy","RT"),
                 stats=c("mu","se"))

ggplot(data=fcdf_quaderr_sum,aes(x=distractor_samequadrant,fill=distractor_samequadrant,color=distractor_samequadrant))+
  geom_col(aes(y=mu_accuracy),position = position_dodge2(1),alpha=0.5)+
  geom_errorbar(aes(ymin=mu_accuracy-se_accuracy,
                    ymax=mu_accuracy+se_accuracy),
                position = position_dodge(1),width=0.4)+
  geom_point(data=fcdf_quaderr_sub,aes(y=accuracy),position = position_dodge(1))+
  geom_line(data=fcdf_quaderr_sub,aes(y=accuracy,group=subid))+
  facet_nested(cols = vars(isgeneralizer))

ggplot(data=fcdf_quaderr_sum,aes(x=distractor_samequadrant,fill=distractor_samequadrant,color=distractor_samequadrant))+
  geom_col(aes(y=mu_RT),position = position_dodge2(1),alpha=0.5)+
  geom_errorbar(aes(ymin=mu_RT-se_RT,
                    ymax=mu_RT+se_RT),
                position = position_dodge(1),width=0.4)+
  geom_point(data=fcdf_quaderr_sub,aes(y=RT),position = position_dodge(1))+
  geom_line(data=fcdf_quaderr_sub,aes(y=RT,group=subid))+
  facet_nested(cols = vars(isgeneralizer))

```

