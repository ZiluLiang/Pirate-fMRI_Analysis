```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(error = FALSE,echo=FALSE, message=FALSE, warning=FALSE)

rm(list = ls())
project_dir = rstudioapi::getActiveProject();
src_dir = file.path(project_dir, "src/R", fsep="/")
llr_dir = file.path(project_dir, "src/LLR", fsep="/")

data_dir = file.path(project_dir, "data","Exp1_fmri", fsep="/")
result_dir = file.path(project_dir, "results","Exp1_fmri", fsep="/")


source(file.path(src_dir,"envSetup.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"funcDef.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"setPlotDefault.R",fsep="/"), local = knitr::knit_global())
```

# Load Data
```{r}
data_with_prob = loadRData(file.path(data_dir,"filtereddata_withprob_compo_lapse-0_01.RData"))
meanscanperf_with_prob = loadRData(file.path(data_dir,"filteredmeanscannerdata_withprob_compo_lapse-0_01.RData"))

```

```{r}
# count N in each group
participant_count = data_with_prob%>%
  distinct(cohort,subid,islearner,isgeneralizer)%>%
  group_by(cohort,islearner,isgeneralizer)%>%
  summarise(n = n())%>%
  mutate(label = paste0(isgeneralizer, "\n n=",n))

nonlearnerids = unique(filter(data_with_prob,islearner=="non-learner")$subid)
nongeneralizerids = unique(filter(data_with_prob,isgeneralizer=="non-generalizer")$subid)
learnerids = unique(filter(data_with_prob,islearner=="learner")$subid)
generalizerids = unique(filter(data_with_prob,isgeneralizer=="generalizer")$subid)
nlearners = length(learnerids)
ngeneralizers = length(generalizerids)
nsub = length(unique(data_with_prob$subid))

#participant_count

labelling_func = function(row){
  l = row[1]
  g = row[2]
  c = row[3]
  return(filter(participant_count,islearner==l&isgeneralizer==g&cohort==c)$label)
}

theme_basic(as_huxtable(participant_count)%>%
      set_align(1, everywhere, "center"))
```


# Plot block average
```{r}
blockdata_sub = aggregate_data(data_with_prob,
                           yvars = c("resp_dist","LLR_trial","LLRx_trial","LLRy_trial","error_x","error_y"),
                           groupbyvars = c("cohort","subid","stage","expt_session","blocknumber_withinsess"),
                           stats = c("mu"),
                           additionalvars = c("islearner","isgeneralizer","session_str"))%>%
  change_cols_name(oldnames = c("mu_LLR_trial","mu_LLRx_trial","mu_LLRy_trial",
                                "mu_resp_dist","mu_error_x","mu_error_y"),
                   newnames = c("LLR","LLR_x","LLR_y",
                                "distance","errorx","errory"))


blockdata_sum = aggregate_data(blockdata_sub,
                           yvars = c("distance","LLR","LLR_x","LLR_y","errorx","errory"),
                           groupbyvars = c("cohort","islearner","isgeneralizer","stage",
                                           "expt_session","blocknumber_withinsess"),
                           stats = c("mu","se","n"),
                           additionalvars = c("session_str"))

blockdata_sub$generalizer_label =
apply(blockdata_sub[ , c("islearner","isgeneralizer","cohort")], 1, labelling_func)
blockdata_sum$generalizer_label =
apply(blockdata_sum[ , c("islearner","isgeneralizer","cohort")], 1, labelling_func)
```




## Plot learner data
### plot rescaled distance to goal of learned participants
```{r}
# with data count

(p = blockdata_sub%>%
  ggplot(aes(x=blocknumber_withinsess,y=distance))+
  geom_point(alpha = 0.1,size = 2,stroke=0)+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_distance))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4)+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(cohort,islearner,generalizer_label),
               scales = "free_x",space = "free_x",
               axes = "all")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",
       title = "Distance to correct location")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_classified','.png')),plot = p,device = 'png',width = 11,height = 12)
```

### plot mean LLR of learned participants
```{r}
#withdatacount
(p = blockdata_sub%>%
  ggplot(aes(x=blocknumber_withinsess,y=LLR))+
  geom_point(alpha = 0.1,size = 2,stroke=0)+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_LLR))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4)+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(cohort,islearner,generalizer_label),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean LLR",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_classified','.png')),plot = p,device = 'png',width = 15,height = 15)
```

##Compare cohort
###side by side comparison all blocks
```{r}
(p = blockdata_sub%>%
   mutate(addtext=if_else(session_str=="refresher"&isgeneralizer=="generalizer"&stage=="train"&LLR<0,subid,""))%>%
  ggplot(aes(x=blocknumber_withinsess,y=LLR,color=cohort))+
  geom_point(alpha = 0.1,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_LLR),
                position=position_dodge(0.9))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4,
                position=position_dodge(0.9))+
   geom_text(aes(label=addtext,x=0.8*blocknumber_withinsess,y=0.8*LLR),size=2.5,fontface="bold")+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean LLR",color = "cohort",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_classified_cohortsidebyside','.png')),plot = p,device = 'png',width = 10,height = 7)
```

```{r}
(p = blockdata_sub%>%
   #mutate(addtext=if_else(session_str=="refresher"&isgeneralizer=="generalizer"&stage=="train"&LLR<0,subid,""))%>%
  ggplot(aes(x=blocknumber_withinsess,y=distance,color=cohort))+
  geom_point(alpha = 0.1,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_distance),
                position=position_dodge(0.9))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4,
                position=position_dodge(0.9))+
  #geom_text(aes(label=addtext,x=0.8*blocknumber_withinsess,y=0.8*distance),size=2.5,fontface="bold")+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",color = "cohort",
       title = "Distance to correct location")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_classified_cohortsidebyside','.png')),plot = p,device = 'png',width = 10,height = 7)
```


###average performance of last pretraining cycle to scanner learner only
```{r}
Lsub_lastpretrain2scan = blockdata_sub%>%
  mutate(cycle = case_when(stage=="train"&expt_session==1~ceil(blocknumber_withinsess/2),
                           stage=="test"&expt_session==1~blocknumber_withinsess,
                           expt_session==2~blocknumber_withinsess+6,
                           expt_session==3~blocknumber_withinsess+6+3))%>%
  filter(islearner=="learner"&cycle>=6)%>%
  aggregate_data(groupbyvars = c("cohort", "subid","stage","expt_session","cycle"),
                 additionalvars = c("islearner","isgeneralizer","session_str","blocknumber_withinsess"),
                 yvars = c("distance","LLR"),
                 stats="mu")%>%
  change_cols_name(paste0("mu_",c("distance","LLR")), c("distance","LLR"))
Lsum_lastpretrain2scan = Lsub_lastpretrain2scan%>%
  aggregate_data(groupbyvars = c("cohort", "islearner","isgeneralizer","stage","expt_session","cycle"),
                 additionalvars = c("session_str","blocknumber_withinsess"),
                 yvars = c("distance","LLR"),
                 stats=c("mu","se"))
  
(p = Lsub_lastpretrain2scan%>%
  ggplot(aes(x=cycle,y=LLR,color=cohort))+
  geom_rect(aes(xmin=10-.5,xmax=13+.5,ymin=-Inf, ymax=+Inf),
              fill='grey', color='lightgrey',alpha=0.01)+
  geom_point(alpha = 0.2,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_col(data = Lsum_lastpretrain2scan,
            aes(x=cycle,y=mu_LLR),fill=NA,
                position=position_dodge(0.9))+
  geom_errorbar(data = Lsum_lastpretrain2scan,
                aes(x=cycle,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4,
                position=position_dodge(0.9))+
    geom_text(aes(x=11.5,
                  y=if_else(isgeneralizer=="non-generalizer"&stage=="test",2,-2),
                  label="scanning"),
                  color="black",fontface="bold")+
  facet_nested(cols =vars(stage),
               rows = vars(isgeneralizer),
               scales = "free_x",space = "free_x",axes="all",remove_labels="none")+
  scale_x_continuous(breaks = seq(6,13,1))+
  labs(x="block number",y="mean LLR",color = "cohort",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 4,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_lastpretrain2scanning_cohortsidebyside','.png')),plot = p,device = 'png',width = 9,height = 6)
```

```{r}
(p = Lsub_lastpretrain2scan%>%
  ggplot(aes(x=cycle,y=distance,color=cohort))+
  geom_point(alpha = 0.2,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_rect(inherit.aes = F,aes(xmin=10-.5,xmax=13+.5,ymin=0, ymax=+Inf),
              fill='grey', color='lightgrey',alpha=0.01)+
  geom_col(data = Lsum_lastpretrain2scan,
            aes(x=cycle,y=mu_distance),fill=NA,
                position=position_dodge(0.9))+
  geom_errorbar(data = Lsum_lastpretrain2scan,
                aes(x=cycle,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4,
                position=position_dodge(0.9))+
    geom_text(aes(x=11.5,y=1.5,
                  label="scanning"),
                  color="black",fontface="bold")+
  facet_nested(cols =vars(stage),
               rows = vars(isgeneralizer),
               scales = "free_x",space = "free_x",axes="all",remove_labels="none")+
  scale_x_continuous(breaks = seq(6,13,1))+
  scale_y_continuous(trans="sqrt")+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",color = "cohort",
       title = "Distance to goal")+
  theme(aspect.ratio = 4,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_lastpretrain2scanning_cohortsidebyside','.png')),plot = p,device = 'png',width = 9,height = 6)
```




##Plot individual LLR with map resp
#### 2D only
```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 2)+
    geom_text(data = filter(blockdata_sub, subid == pid),
              aes(x=0.1,y=1.8,label = sprintf("LLR = %s", formatC(LLR, digits = 2))))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+ #RColorBrewer::brewer.pal(5, "Dark2"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "y feature",shape = "x feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  show(p)
  ggsave(file.path(result_dir,'individualmaps',"participant_map_withLLR",paste0(pid,'.png')),plot = p,device = 'png',width = 16,height = 8)
}
```

#### 2D + 1D
```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 3)+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=2,label = sprintf("2D LLR = %s", formatC(LLR, digits = 2))))+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=1.6,
                  label = sprintf("1D LLR(x,y): [%s, %s]",
                                  formatC(LLR_x, digits = 2),
                                  formatC(LLR_y, digits = 2))))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "x feature",shape = "y feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"participant_map_with1dLLR",paste0(pid,'.png')),plot = p,width = 16,height = 9)
  
}
```

### average response map
```{r}
generalize_js = c("non-generalizer","generalizer")
learn_ks = c("non-learner","learner")
for (j in c(1,2)){
  for (k in c(2)){
    ave_resp_map_df = data_with_prob %>%
    filter(isgeneralizer==generalize_js[j],islearner==learn_ks[k])%>%
    aggregate_data(
      yvars = c("resp_x","resp_y"),
      groupbyvars = c("islearner","isgeneralizer","stage","expt_session","blocknumber_withinsess","stim_id"),
      stats = c("mu"),
      additionalvars = c("expt_block","session_str","stim_x","stim_y","stim_attrx","stim_attry")
    )%>%
    change_cols_name(oldnames = c("mu_resp_x","mu_resp_y"),
                     newnames = c("resp_x", "resp_y"))%>%
    mutate(stim_attrx = factor(stim_attrx),
             stim_attry = factor(stim_attry))
  
  
  nb_train = length(unique(filter(ave_resp_map_df,stage=="train")$expt_block))
  nb_test = length(unique(filter(ave_resp_map_df,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = ave_resp_map_df%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 3)+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title =paste0("average response map: ", learn_ks[k],'_',generalize_js[j]),
      color = "y feature",shape = "x feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"averagemaps",
                   paste0(learn_ks[k],'_',generalize_js[j],'.png')),plot = p,width = 16,height = 9)
  }
}

```


# Plot using cycle instead of block

## combined cohort, generalizer only

```{r}
cycledata_sub = aggregate_data(data_with_prob,
                           yvars = c("resp_dist","LLR_trial","LLRx_trial","LLRy_trial","error_x","error_y"),
                           groupbyvars = c("cohort","subid","stage","expt_session","cycle"),
                           stats = c("mu"),
                           additionalvars = c("islearner","isgeneralizer","session_str"))%>%
  change_cols_name(oldnames = c("mu_LLR_trial","mu_LLRx_trial","mu_LLRy_trial",
                                "mu_resp_dist","mu_error_x","mu_error_y"),
                   newnames = c("LLR","LLR_x","LLR_y",
                                "distance","errorx","errory"))


cycledata_sum = aggregate_data(cycledata_sub,
                           yvars = c("distance","LLR","LLR_x","LLR_y","errorx","errory"),
                           groupbyvars = c("islearner","isgeneralizer","stage",
                                           "expt_session","cycle"),
                           stats = c("mu","se","n"),
                           additionalvars = c("session_str"))

cycledata_sub = filter(cycledata_sub,isgeneralizer=="generalizer"&islearner=="learner")
cycledata_sum = filter(cycledata_sum,isgeneralizer=="generalizer"&islearner=="learner")
```


```{r}
annot_sesstext2=data.frame(x=c(3.5,8,11.5),y=c(-3,-3,-3),seslab=c("pretrain","refresher","scanning"))
(pllr = cycledata_sub%>%
  ggplot(aes(x=cycle,y=LLR,color=stage))+
  geom_rect(aes(xmin=6.5,xmax=9.5,ymin=-Inf,ymax=Inf),color="lightgrey",fill="lightgrey",alpha=0.03)+
  geom_text(inherit.aes = F,data=annot_sesstext2,mapping=aes(x=x,y=y,label=seslab),size=4,fontface="bold")+
  geom_point(alpha = 0.1,size = 2,stroke=0,position=position_dodge(1))+
  geom_point(data = cycledata_sum,shape="diamond",size=3,
            aes(x=cycle,y=mu_LLR),position=position_dodge(1))+
  geom_line(data = cycledata_sum,
            aes(x=cycle,y=mu_LLR),position=position_dodge(1))+
  geom_errorbar(data = cycledata_sum,
                aes(x=cycle,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4,position=position_dodge(1))+
  scale_x_continuous(breaks = seq(1,13,1))+
  scale_color_manual(values= twolevel_colors)+
  labs(x="cycle",y="mean LLR",subtitle="Log-Likelihood Ratio (LLR)",color="Stimuli")+
  theme(aspect.ratio = 0.8,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_classified_Gbycycle','.png')),plot = pllr,device = 'png',width = 10,height = 8)
```

```{r}
annot_sesstext=data.frame(x=c(3.5,8,11.5),y=c(-.1,-.1,-.1),seslab=c("pretrain","refresher","scanning"))
(pdistance = cycledata_sub%>%
  ggplot(aes(x=cycle,y=distance,color=stage))+
  geom_rect(aes(xmin=6.5,xmax=9.5,ymin=-Inf,ymax=Inf),color="lightgrey",fill="lightgrey",alpha=0.03)+
  geom_text(inherit.aes = F,data=annot_sesstext,mapping=aes(x=x,y=y,label=seslab),size=4,fontface="bold")+
  geom_point(alpha = 0.1,size = 2,stroke=0,position=position_dodge(1))+
  geom_point(data = cycledata_sum,shape="diamond",size=3,
            aes(x=cycle,y=mu_distance),position=position_dodge(1))+
  geom_line(data = cycledata_sum,
            aes(x=cycle,y=mu_distance),position=position_dodge(1))+
  geom_errorbar(data = cycledata_sum,
                aes(x=cycle,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4,position=position_dodge(1))+
  scale_x_continuous(breaks = seq(1,13,1))+
  scale_color_manual(values= twolevel_colors)+
  labs(x="cycle",y="mean distance",subtitle="Distance to correct location",color="Stimuli")+
  theme(aspect.ratio = 0.8,legend.position = "top"))

ggsave(file.path(result_dir,paste0('dist2goal_classified_Gbycycle','.png')),plot = pdistance,device = 'png',width = 10,height = 8)
```

```{r}

p.gbehav = ggarrange(
  pdistance, pllr, # list of plots
  labels = "AUTO", # labels
  label.y=0.95,
  common.legend = TRUE, # COMMON LEGEND
  legend = "top", # legend position
  align = "hv", # Align them both, horizontal and vertical
  nrow = 1 # number of rows
)
p.gbehav = annotate_figure(p.gbehav, top = text_grob("Generalizer Response Accuracy", 
               color = "black", face = "bold", size = 14))

ggsave(file.path(result_dir,paste0('responseacc_Gbycycle','.png')),plot = p.gbehav,device = 'png',width = 9,height = 4.5)
```

