
```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(error = FALSE,echo=FALSE, message=FALSE, warning=FALSE)

rm(list = ls())
project_dir = rstudioapi::getActiveProject();
src_dir = file.path(project_dir, "src/R", fsep="/")
llr_dir = file.path(project_dir, "src/LLR", fsep="/")

data_dir = file.path(project_dir, "data","Exp1_fmri", fsep="/")
result_dir = file.path(project_dir, "results","Exp1_fmri", fsep="/")


source(file.path(src_dir,"envSetup.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"funcDef.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"setPlotDefault.R",fsep="/"), local = knitr::knit_global())
```


## Load data
```{r loadDataset}
fn = file.path(data_dir,"all_participants.csv",fsep="/")
trialdata = read.table(fn, header = TRUE, sep = ",")%>%
  filter(subid!="sub031") # exclude this participant because fMRI data collection was incomplete

data = trialdata%>%filter(ctrl_expt=="True"&ctrl_resp == 1)%>%
  dplyr::select(-c("ctrl_expt","ctrl_resp"))%>%
  group_by(subid,expt_session)%>%
  arrange(expt_block,expt_trial)%>%
  mutate(expt_trial = row_number(),
         cohort = factor(cohort, levels=c(1,2), labels=c("first cohort", "second cohort")))

#check if number of trials is correct:
#nsub = length(unique(respdata$subid)) = 29
#ntrialpersub = nrow(respdata)/nsub = 204+27+25*4 = 331
range_xy = c(max(data$stim_x)-min(data$stim_x),
             max(data$stim_y)-min(data$stim_y))
data = data%>%
  mutate(stage = ifelse(training==1,"train","test"))%>%
  mutate(training = factor(training,levels = c(1,0),labels = c("training stimuli","test stimuli")),
         stage = factor(stage,levels = c("train","test")),
         session_str = factor(expt_session, levels = c(1,2,3),labels=c("pretraining","refresher","scanning")),
         stim_xO = stim_x,
         stim_yO = stim_y,
         resp_xO = resp_x,
         resp_yO = resp_y,
         ##rescale so that correct location is between -1 and 1
         stim_x = round(2*stim_x/range_xy[1],digits = 3),
         stim_y = round(2*stim_y/range_xy[2],digits = 3),
         resp_x = round(2*resp_x/range_xy[1],digits = 3),
         resp_y = round(2*resp_y/range_xy[2],digits = 3))%>%
  mutate(resp_dist = sqrt((resp_x-stim_x)^2+(resp_y-stim_y)^2))

re_Assign_block = data%>%distinct(subid,stage,expt_block,.keep_all = T)%>%
  group_by(subid,stage,expt_session)%>%
  arrange(expt_block)%>%
  mutate(blocknumber_withinsess = row_number(),
         nblocks = n())%>%
  mutate(blocknumws_normalized = blocknumber_withinsess/nblocks)%>%
  dplyr::select(c("subid","stage","expt_block","nblocks","blocknumber_withinsess","blocknumws_normalized"))
data = left_join(data,re_Assign_block)

meanscanperf = data%>%
  filter(expt_session==3)%>%
  aggregate_data(groupbyvars = c("subid","stage","stim_id"),
                 yvars=c("resp_x","resp_y","resp_xO","resp_yO"),
                 additionalvars = c("session_str","cohort","stim_attrx","stim_attry",
                                    "training","expt_session","expt_block","expt_trial",
                                    "stim_x","stim_y", "stim_xO","stim_yO"),
                 stats="mu")%>%
  change_cols_name(oldnames = paste0("mu_",c("resp_x","resp_y","resp_xO","resp_yO")),
                   newnames = c("resp_x","resp_y","resp_xO","resp_yO"))
# meanscanperf should have 25*ntotoalsub rows
```


## LLR
### load model distribution
```{r}
tryCatch(
  expr = {
    load(file.path(llr_dir,"probDF_data_compo_withlapse.RData"))
  },
  error = function(e){
    print("please generate probability distribution data")
  })
```

### get LLR for each response
```{r}
find_resp_probs = function(respdf,rowid,unique_stimloc,prob_df_list,base){
      library(dplyr)
      sx = respdf$stim_x[rowid]
      sy = respdf$stim_y[rowid]
      rx = respdf$resp_x[rowid]
      ry = respdf$resp_y[rowid]

      ind = filter(unique_stimloc,x == sx & y == sy)$loc_id
      search_df=prob_df_list[[ind]]
      xlb = base[max(which(base<=rx))]
      xub = base[min(which(base>rx))]
      ylb = base[max(which(base<=ry))]
      yub = base[min(which(base>ry))]
      
      new_row = filter(search_df,x<xub & x>=xlb & y<yub & y>=ylb)
      if(nrow(new_row)==0){
        new_row[1, ] <- NA
        new_row = new_row%>%
        mutate(resp_x = rx, resp_y = ry,
               subid = respdf$subid[rowid],
               expt_session = respdf$expt_sess[rowid],
               expt_block = respdf$expt_block[rowid],
               expt_trial = respdf$expt_trial[rowid])
      }else{
        new_row = new_row%>%
        mutate(resp_x = rx, resp_y = ry,
               subid  = respdf$subid[rowid],
               expt_session = respdf$expt_sess[rowid],
               expt_block = respdf$expt_block[rowid],
               expt_trial = respdf$expt_trial[rowid])
      }
      
      return(new_row)
}

tryCatch(
  expr = {
    data_with_prob = loadRData(file.path(data_dir,"data_withprob_compo_lapse-0_01.RData"))
    meanscanperf_with_prob = loadRData(file.path(data_dir,"meanscannerdata_withprob_compo_lapse-0_01.RData"))
  },
  error = function(e){
    cl<- makeCluster(detectCores()-1)
    clusterExport(cl=cl,
                  varlist = c("data","meanscanperf","unique_stimloc","base","prob_df_list","find_resp_probs"),
                  envir=environment())
    new_rows <- pblapply(cl = cl,X = seq(1,nrow(data)),
                        FUN = function(j){find_resp_probs(data,j,unique_stimloc,prob_df_list,base)})
    new_rowsmsd <- pblapply(cl = cl,X = seq(1,nrow(meanscanperf)),
                        FUN = function(j){find_resp_probs(meanscanperf,j,unique_stimloc,prob_df_list,base)})
    stopCluster(cl)
    

    data_with_prob = left_join(data,do.call(rbind,new_rows))
    meanscanperf_with_prob = left_join(meanscanperf,do.call(rbind,new_rowsmsd))
    save(data_with_prob, file   = file.path(data_dir,"data_withprob_compo_lapse-0_01.RData"))
    save(meanscanperf_with_prob, file = file.path(data_dir,"meanscannerdata_withprob_compo_lapse-0_01.RData"))
    
  }
)

# filter out sub031 because withdrew from data collection and data was incomplete
data_with_prob = loadRData(file.path(data_dir,"data_withprob_compo_lapse-0_01.RData"))
meanscanperf_with_prob = loadRData(file.path(data_dir,"meanscannerdata_withprob_compo_lapse-0_01.RData"))
```


### classify learner

```{r}
data_with_prob = data_with_prob%>%
  mutate(error_x = abs(stim_x - resp_x),
         error_y = abs(stim_y - resp_y))%>%
  mutate(binorm_lap = BND_compo_lap)%>%
  mutate(LR_trial = binorm_lap/uniform,
         LRx_trial = UND_x_lap/uniform, 
         LRy_trial = UND_y_lap/uniform,)%>%
  mutate(LLR_trial = log(LR_trial),
         LLRx_trial = log(LRx_trial),
         LLRy_trial = log(LRy_trial))%>%
  group_by(subid)%>%
    arrange(stage,expt_session,expt_block)%>%
    mutate(trialid_withinstage = row_number(),
           ntrials = n())%>%
    mutate(trialid_normalized = trialid_withinstage/ntrials)%>%
  ungroup()

meanscanperf_with_prob = meanscanperf_with_prob%>%
  mutate(error_x = abs(stim_x - resp_x),
         error_y = abs(stim_y - resp_y))%>%
  mutate(binorm_lap = BND_compo_lap)%>%
  mutate(LR_trial = binorm_lap/uniform,
         LRx_trial = UND_x_lap/uniform, 
         LRy_trial = UND_y_lap/uniform,)%>%
  mutate(LLR_trial = log(LR_trial),
         LLRx_trial = log(LRx_trial),
         LLRy_trial = log(LRy_trial))%>%
  group_by(subid)%>%
    arrange(stage)%>%
    mutate(trialid_withinstage = row_number(),
           ntrials = n())%>%
    mutate(trialid_normalized = trialid_withinstage/ntrials)%>%
  ungroup()


sub_LLR_data = aggregate_data(data_with_prob,
                              groupbyvars = c("cohort","subid","stage","expt_session","blocknumber_withinsess"),
                              yvars = c("LLR_trial","LLRx_trial","LLRy_trial","resp_dist"),
                              stats = c("mu"),
                              additionalvars = c("expt_coordsys","expt_curricula","expt_session"))%>%
  change_cols_name(oldnames = c("mu_LLR_trial","mu_LLRx_trial","mu_LLRy_trial","mu_resp_dist"),
                   newnames = c("LLR","LLR_x","LLR_y","distance"))%>%
  dplyr::select(-c(starts_with("n_")))%>%
  group_by(subid,expt_session,stage)%>%
  mutate(nblock = max(blocknumber_withinsess))%>%
  ungroup()

meanscannerLLR = aggregate_data(meanscanperf_with_prob,
                                groupbyvars = c("cohort","subid","stage"),
                              yvars = c("LLR_trial","LLRx_trial","LLRy_trial"),
                              stats = c("mu"))%>%
  change_cols_name(oldnames = c("mu_LLR_trial","mu_LLRx_trial","mu_LLRy_trial"),
                   newnames = c("LLR","LLR_x","LLR_y"))%>%
  dplyr::select(-c(starts_with("n_")))

## old way
dividesub = sub_LLR_data%>%
  filter(blocknumber_withinsess==nblock&expt_session!=2)#%>%
#  aggregate_data(groupbyvars = c("subid","expt_session","stage"),
#                 yvars = "LLR",
#                 stats = "mu")%>%
#  aggregate_data(groupbyvars = c("subid","stage"),
#                 yvars = "mu_LLR",stats = "mu")%>%
#  change_cols_name("mu_mu_LLR","LLR")
learnerids = unique(filter(dividesub,expt_session==3&stage=="train"&LLR>=0)$subid)
generalizerids = unique(filter(dividesub,expt_session==3&stage=="test"&LLR>=0)$subid)
print("nonlearner")
(nonlearnerids = unique(filter(dividesub,expt_session==3&stage=="train"&LLR<0)$subid))
print("nongeneralizer")
(nongeneralizerids = unique(filter(dividesub,expt_session==3&stage=="test"&LLR<0)$subid))


#new way: by using the average performance of scanning
learnerids = unique(filter(meanscannerLLR, stage=="train"&LLR>=0)$subid)
generalizerids = unique(filter(meanscannerLLR,  stage=="test"&LLR>=0)$subid)
print("nonlearner")
(nonlearnerids = unique(filter(meanscannerLLR,  stage=="train"&LLR<0)$subid))
print("nongeneralizer")
(nongeneralizerids = unique(filter(meanscannerLLR, stage=="test"&LLR<0)$subid))

data_with_prob = data_with_prob%>%
  mutate(islearner = factor(ifelse(subid%in%learnerids,1,0),
                            levels = c(1,0),labels = c("learner","non-learner")),
         isgeneralizer = factor(ifelse(subid%in%generalizerids ,1,0),
                                levels = c(1,0),labels = c("generalizer","non-generalizer")))

meanscanperf_with_prob = meanscanperf_with_prob%>%
  mutate(islearner = factor(ifelse(subid%in%learnerids,1,0),
                            levels = c(1,0),labels = c("learner","non-learner")),
         isgeneralizer = factor(ifelse(subid%in%generalizerids ,1,0),
                                levels = c(1,0),labels = c("generalizer","non-generalizer")))

sub_LLR_data = sub_LLR_data%>%
  mutate(islearner = factor(ifelse(subid%in%learnerids,1,0),
                            levels = c(1,0),labels = c("learner","non-learner")),
         isgeneralizer = factor(ifelse(subid%in%generalizerids ,1,0),
                                levels = c(1,0),labels = c("generalizer","non-generalizer")))
```

```{r}
nlearners = length(learnerids)
ngeneralizers = length(generalizerids)
nsub = length(unique(sub_LLR_data$subid))
participant_count = sub_LLR_data%>%
  distinct(cohort,subid,islearner,isgeneralizer)%>%
  group_by(cohort,islearner,isgeneralizer)%>%
  summarise(n = n())%>%
  mutate(label = paste0(isgeneralizer, "\n n=",n))

#participant_count

labelling_func = function(row){
  l = row[1]
  g = row[2]
  c = row[3]
  return(filter(participant_count,islearner==l&isgeneralizer==g&cohort==c)$label)
}

theme_basic(as_huxtable(participant_count)%>%
      set_align(1, everywhere, "center"))
```

###Plot correlation between last block of training and test
```{r}
sub_LLR_data = sub_LLR_data%>%
  group_by(subid,expt_session,stage)%>%
  mutate(nblock = max(blocknumber_withinsess))%>%
  ungroup()

last_pretrain = filter(sub_LLR_data,expt_session==1&blocknumber_withinsess==nblock)%>%
  dplyr::select(-c("nblock","expt_session","blocknumber_withinsess"))%>%
  pivot_longer(cols=c("LLR","LLR_x","LLR_y"),
               names_to = "performance_metric",
               values_to = "lastpretrain")

meanscanning  = meanscannerLLR%>%
  mutate(islearner = factor(ifelse(subid%in%learnerids,1,0),
                            levels = c(1,0),labels = c("learner","non-learner")),
         isgeneralizer = factor(ifelse(subid%in%generalizerids ,1,0),
                                levels = c(1,0),labels = c("generalizer","non-generalizer")))%>%
  pivot_longer(cols=c("LLR","LLR_x","LLR_y"),
               names_to = "performance_metric",
               values_to = "scanning")

pretrainscanner_behavsum_long = left_join(last_pretrain,meanscanning,by=c("cohort","subid","stage","islearner","isgeneralizer","performance_metric"))
```

```{r}
annot_change <- data.frame(
  label = c("nL\U2192L", "nG\U2192G","L\U2192nL", "G\U2192nG"),
  stage = c("train","test","train","test"),
  x     = c(-2.5,-2.5,2.5,2.5),
  y     = c(2.5,2.5,-2.5,-2.5)
)%>%
  mutate(stage=factor(stage,levels=c("train","test"),
                      labels=c("Training stimuli", "Test stimuli")))


p_trsc_corr = pretrainscanner_behavsum_long %>%
  filter(performance_metric=="LLR")%>%
  mutate(outlierlabel=if_else(xor(scanning>0,lastpretrain>0),subid,""),
         stage=factor(stage,levels=c("train","test"),
                      labels=c("Training stimuli", "Test stimuli")))%>%
  ggplot(aes(x=lastpretrain,y=scanning,color=isgeneralizer))+
  facet_nested_wrap(vars(stage,cohort),nrow = 2,
            remove_labels="none",axes="all",
            )+
  geom_point(alpha=0.5)+
  geom_text(aes(label=outlierlabel),
            fontface="bold",size=3)+
  geom_text(data=annot_change,aes(x=x,y=y,label=label),
            fontface="bold",inherit.aes=F,size=6)+
  geom_abline(slope=1,intercept=0,linetype="dashed",color="grey")+
  geom_vline(xintercept=0,linetype="dashed",color="grey")+
  geom_hline(yintercept=0,linetype="dashed",color="grey")+
  scale_color_manual(values=twolevel_colors)+
  labs(x="last pretraining block LLR", y = "average LLR across scanning blocks",
       title="Correlation between LLR in \nlast pretraining block and average across scanning blocks")+
  theme(legend.position = "top",legend.direction = "horizontal")
p_trsc_corr
ggsave(file.path(result_dir,paste0('LLR_corr_pretrain2scan','.png')),plot = p_trsc_corr,device = 'png',width = 8,height = 9)


p_trsc_corr2 = pretrainscanner_behavsum_long %>%
  filter(performance_metric=="LLR"&cohort=="second cohort")%>%
  mutate(outlierlabel=if_else(scanning<0&lastpretrain>0,subid,""),
         stage=factor(stage,levels=c("train","test"),
                      labels=c("Training stimuli", "Test stimuli")))%>%
  ggplot(aes(x=lastpretrain,y=scanning,color=isgeneralizer))+
  facet_nested_wrap(vars(stage),nrow = 1,
            remove_labels="none",axes="all",
            )+
  geom_point(alpha=0.5)+
  geom_text(aes(label=outlierlabel),
            fontface="bold",size=3)+
  geom_text(data=annot_change,aes(x=x,y=y,label=label),
            fontface="bold",inherit.aes=F,size=6)+
  geom_abline(slope=1,intercept=0,linetype="dashed",color="grey")+
  geom_vline(xintercept=0,linetype="dashed",color="grey")+
  geom_hline(yintercept=0,linetype="dashed",color="grey")+
  scale_color_manual(values=twolevel_colors)+
  labs(x="last pretraining block LLR", y = "average LLR across scanning blocks",
       title="Correlation between LLR in \nlast pretraining block and average across scanning blocks")+
  theme(legend.position = "top",legend.direction = "horizontal")
p_trsc_corr2
ggsave(file.path(result_dir,paste0('LLR_corr_pretrain2scan_cohort2only','.png')),plot = p_trsc_corr2,device = 'png',width = 10,height = 6)

```

### plot correlation between train and test
```{r}
trainperf  = sub_LLR_data%>%
  filter(stage=="train")%>%
  mutate(tmp_keeprow = if_else(expt_session==1&mod(blocknumber_withinsess,2)==1,0,
                               if_else(expt_session==2,0,1)))%>%
  filter(tmp_keeprow==1)%>%
  pivot_longer(cols=c("distance","LLR","LLR_x","LLR_y"),
               names_to = "performance_metric",
               values_to = "train")%>%
  mutate(cycle=if_else(expt_session==1,blocknumber_withinsess/2,blocknumber_withinsess+6))%>%
  dplyr::select(-c("tmp_keeprow","blocknumber_withinsess","nblock","stage","expt_coordsys","expt_curricula"))

testperf  = sub_LLR_data%>%
  filter(stage=="test")%>%
  pivot_longer(cols=c("distance","LLR","LLR_x","LLR_y"),
               names_to = "performance_metric",
               values_to = "test")%>%
  mutate(cycle = if_else(expt_session==1,blocknumber_withinsess,blocknumber_withinsess+6))%>%
  dplyr::select(-c("blocknumber_withinsess","nblock","stage","expt_coordsys","expt_curricula" ))

traintest_behavsum_long = left_join(trainperf,testperf,
                                    by=c("cohort","subid","expt_session",
                                         "islearner","isgeneralizer",
                                         "performance_metric","cycle")
                                    )
```

```{r}
p_trte_corr = traintest_behavsum_long %>%
  filter(performance_metric=="LLR")%>%
  ggplot(aes(x=train,y=test,color=isgeneralizer))+
  facet_nested_wrap(vars(cohort,expt_session,cycle),nrow = 2,
            remove_labels="none",axes="all",
            )+
  geom_point(alpha=0.7)+
  #geom_text(aes(label=outlierlabel))+
  geom_abline(slope=1,intercept=0,linetype="dashed",color="grey")+
  geom_vline(xintercept=0,linetype="dashed",color="grey")+
  geom_hline(yintercept=0,linetype="dashed",color="grey")+
  scale_color_manual(values=twolevel_colors)+
  theme(legend.position = "top",legend.direction = "horizontal")
p_trte_corr
ggsave(file.path(result_dir,paste0('LLR_corr_train2test','.png')),plot = p_trte_corr,device = 'png',width = 16,height = 9)
```




## Filter unreliable participants and get final group count
```{r}
#remove particiant in the second cohort who changed from G->nG
data_with_prob = data_with_prob%>%
  filter(!subid%in%c("sub027","sub113","sub119","sub126"))

meanscanperf_with_prob = meanscanperf_with_prob%>%
  filter(!subid%in%c("sub027","sub113","sub119","sub126"))

# count subject again
participant_count = data_with_prob%>%
  distinct(cohort,subid,islearner,isgeneralizer)%>%
  group_by(cohort,islearner,isgeneralizer)%>%
  summarise(n = n())%>%
  mutate(label = paste0(isgeneralizer, "\n n=",n))

nonlearnerids = unique(filter(data_with_prob,islearner=="non-learner")$subid)
nongeneralizerids = unique(filter(data_with_prob,isgeneralizer=="non-generalizer")$subid)
learnerids = unique(filter(data_with_prob,islearner=="learner")$subid)
generalizerids = unique(filter(data_with_prob,isgeneralizer=="generalizer")$subid)
nlearners = length(learnerids)
ngeneralizers = length(generalizerids)
nsub = length(unique(sub_LLR_data$subid))

#participant_count

labelling_func = function(row){
  l = row[1]
  g = row[2]
  c = row[3]
  return(filter(participant_count,islearner==l&isgeneralizer==g&cohort==c)$label)
}

theme_basic(as_huxtable(participant_count)%>%
      set_align(1, everywhere, "center"))
```



```{r}
blockdata_sub = aggregate_data(data_with_prob,
                           yvars = c("resp_dist","LLR_trial","LLRx_trial","LLRy_trial","error_x","error_y"),
                           groupbyvars = c("cohort","subid","stage","expt_session","blocknumber_withinsess"),
                           stats = c("mu"),
                           additionalvars = c("islearner","isgeneralizer","session_str"))%>%
  change_cols_name(oldnames = c("mu_LLR_trial","mu_LLRx_trial","mu_LLRy_trial",
                                "mu_resp_dist","mu_error_x","mu_error_y"),
                   newnames = c("LLR","LLR_x","LLR_y",
                                "distance","errorx","errory"))


blockdata_sum = aggregate_data(blockdata_sub,
                           yvars = c("distance","LLR","LLR_x","LLR_y","errorx","errory"),
                           groupbyvars = c("cohort","islearner","isgeneralizer","stage",
                                           "expt_session","blocknumber_withinsess"),
                           stats = c("mu","se","n"),
                           additionalvars = c("session_str"))

blockdata_sub$generalizer_label =
apply(blockdata_sub[ , c("islearner","isgeneralizer","cohort")], 1, labelling_func)
blockdata_sum$generalizer_label =
apply(blockdata_sum[ , c("islearner","isgeneralizer","cohort")], 1, labelling_func)
```



## Plot learner data
### plot rescaled distance to goal of learned participants
```{r}
# with data count

(p = blockdata_sub%>%
  ggplot(aes(x=blocknumber_withinsess,y=distance))+
  geom_point(alpha = 0.1,size = 2,stroke=0)+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_distance))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4)+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(cohort,islearner,generalizer_label),
               scales = "free_x",space = "free_x",
               axes = "all")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",
       title = "Distance to correct location")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_classified','.png')),plot = p,device = 'png',width = 11,height = 12)
```

### plot mean LLR of learned participants
```{r}
#withdatacount
(p = blockdata_sub%>%
  ggplot(aes(x=blocknumber_withinsess,y=LLR))+
  geom_point(alpha = 0.1,size = 2,stroke=0)+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_LLR))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4)+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(cohort,islearner,generalizer_label),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean LLR",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_classified','.png')),plot = p,device = 'png',width = 15,height = 15)
```

##Compare cohort
###side by side comparison all blocks
```{r}
(p = blockdata_sub%>%
   mutate(addtext=if_else(session_str=="refresher"&isgeneralizer=="generalizer"&stage=="train"&LLR<0,subid,""))%>%
  ggplot(aes(x=blocknumber_withinsess,y=LLR,color=cohort))+
  geom_point(alpha = 0.1,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_LLR),
                position=position_dodge(0.9))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4,
                position=position_dodge(0.9))+
   geom_text(aes(label=addtext,x=0.8*blocknumber_withinsess,y=0.8*LLR),size=2.5,fontface="bold")+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean LLR",color = "cohort",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_classified_cohortsidebyside','.png')),plot = p,device = 'png',width = 10,height = 7)
```

```{r}
(p = blockdata_sub%>%
   #mutate(addtext=if_else(session_str=="refresher"&isgeneralizer=="generalizer"&stage=="train"&LLR<0,subid,""))%>%
  ggplot(aes(x=blocknumber_withinsess,y=distance,color=cohort))+
  geom_point(alpha = 0.1,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_line(data = blockdata_sum,
            aes(x=blocknumber_withinsess,y=mu_distance),
                position=position_dodge(0.9))+
  geom_errorbar(data = blockdata_sum,
                aes(x=blocknumber_withinsess,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4,
                position=position_dodge(0.9))+
  #geom_text(aes(label=addtext,x=0.8*blocknumber_withinsess,y=0.8*distance),size=2.5,fontface="bold")+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x",axes = "all",remove_labels="none")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",color = "cohort",
       title = "Distance to correct location")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_classified_cohortsidebyside','.png')),plot = p,device = 'png',width = 10,height = 7)
```


###average performance of last pretraining cycle to scanner learner only
```{r}
Lsub_lastpretrain2scan = blockdata_sub%>%
  mutate(cycle = case_when(stage=="train"&expt_session==1~ceil(blocknumber_withinsess/2),
                           stage=="test"&expt_session==1~blocknumber_withinsess,
                           expt_session==2~blocknumber_withinsess+6,
                           expt_session==3~blocknumber_withinsess+6+3))%>%
  filter(islearner=="learner"&cycle>=6)%>%
  aggregate_data(groupbyvars = c("cohort", "subid","stage","expt_session","cycle"),
                 additionalvars = c("islearner","isgeneralizer","session_str","blocknumber_withinsess"),
                 yvars = c("distance","LLR"),
                 stats="mu")%>%
  change_cols_name(paste0("mu_",c("distance","LLR")), c("distance","LLR"))
Lsum_lastpretrain2scan = Lsub_lastpretrain2scan%>%
  aggregate_data(groupbyvars = c("cohort", "islearner","isgeneralizer","stage","expt_session","cycle"),
                 additionalvars = c("session_str","blocknumber_withinsess"),
                 yvars = c("distance","LLR"),
                 stats=c("mu","se"))
  
(p = Lsub_lastpretrain2scan%>%
  ggplot(aes(x=cycle,y=LLR,color=cohort))+
  geom_rect(aes(xmin=10-.5,xmax=13+.5,ymin=-Inf, ymax=+Inf),
              fill='grey', color='lightgrey',alpha=0.01)+
  geom_point(alpha = 0.2,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_col(data = Lsum_lastpretrain2scan,
            aes(x=cycle,y=mu_LLR),fill=NA,
                position=position_dodge(0.9))+
  geom_errorbar(data = Lsum_lastpretrain2scan,
                aes(x=cycle,
                    y = mu_LLR,
                    ymin = mu_LLR - se_LLR,
                    ymax = mu_LLR + se_LLR),
                width=0.4,
                position=position_dodge(0.9))+
    geom_text(aes(x=11.5,
                  y=if_else(isgeneralizer=="non-generalizer"&stage=="test",2,-2),
                  label="scanning"),
                  color="black",fontface="bold")+
  facet_nested(cols =vars(stage),
               rows = vars(isgeneralizer),
               scales = "free_x",space = "free_x",axes="all",remove_labels="none")+
  scale_x_continuous(breaks = seq(6,13,1))+
  labs(x="block number",y="mean LLR",color = "cohort",
       title = "Log-Likelihood Ratio")+
  theme(aspect.ratio = 4,legend.position = "top"))

ggsave(file.path(result_dir,paste0('LLR_lastpretrain2scanning_cohortsidebyside','.png')),plot = p,device = 'png',width = 9,height = 6)
```

```{r}
(p = Lsub_lastpretrain2scan%>%
  ggplot(aes(x=cycle,y=distance,color=cohort))+
  geom_point(alpha = 0.2,size = 2,stroke=0,
                position=position_dodge(0.9))+
  geom_rect(inherit.aes = F,aes(xmin=10-.5,xmax=13+.5,ymin=0, ymax=+Inf),
              fill='grey', color='lightgrey',alpha=0.01)+
  geom_col(data = Lsum_lastpretrain2scan,
            aes(x=cycle,y=mu_distance),fill=NA,
                position=position_dodge(0.9))+
  geom_errorbar(data = Lsum_lastpretrain2scan,
                aes(x=cycle,
                    y = mu_distance,
                    ymin = mu_distance - se_distance,
                    ymax = mu_distance + se_distance),
                width=0.4,
                position=position_dodge(0.9))+
    geom_text(aes(x=11.5,y=1.5,
                  label="scanning"),
                  color="black",fontface="bold")+
  facet_nested(cols =vars(stage),
               rows = vars(isgeneralizer),
               scales = "free_x",space = "free_x",axes="all",remove_labels="none")+
  scale_x_continuous(breaks = seq(6,13,1))+
  scale_y_continuous(trans="sqrt")+
  labs(x="block number",y="mean distance to goal (a.u.) rescaled",color = "cohort",
       title = "Distance to goal")+
  theme(aspect.ratio = 4,legend.position = "top"))

ggsave(file.path(result_dir,paste0('rescaled_distance_lastpretrain2scanning_cohortsidebyside','.png')),plot = p,device = 'png',width = 9,height = 6)
```




##Plot individual LLR with map resp
#### 2D only
```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 2)+
    geom_text(data = filter(blockdata_sub, subid == pid),
              aes(x=0.1,y=1.8,label = sprintf("LLR = %s", formatC(LLR, digits = 2))))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+ #RColorBrewer::brewer.pal(5, "Dark2"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "y feature",shape = "x feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  show(p)
  ggsave(file.path(result_dir,'individualmaps',"participant_map_withLLR",paste0(pid,'.png')),plot = p,device = 'png',width = 16,height = 8)
}
```

#### 2D + 1D
```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 3)+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=2,label = sprintf("2D LLR = %s", formatC(LLR, digits = 2))))+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=1.6,
                  label = sprintf("1D LLR(x,y): [%s, %s]",
                                  formatC(LLR_x, digits = 2),
                                  formatC(LLR_y, digits = 2))))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "x feature",shape = "y feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"participant_map_with1dLLR",paste0(pid,'.png')),plot = p,width = 16,height = 9)
  
}
```

### average response map
```{r}
generalize_js = c("non-generalizer","generalizer")
learn_ks = c("non-learner","learner")
for (j in c(1,2)){
  for (k in c(2)){
    ave_resp_map_df = data_with_prob %>%
    filter(isgeneralizer==generalize_js[j],islearner==learn_ks[k])%>%
    aggregate_data(
      yvars = c("resp_x","resp_y"),
      groupbyvars = c("islearner","isgeneralizer","stage","expt_session","blocknumber_withinsess","stim_id"),
      stats = c("mu"),
      additionalvars = c("expt_block","session_str","stim_x","stim_y","stim_attrx","stim_attry")
    )%>%
    change_cols_name(oldnames = c("mu_resp_x","mu_resp_y"),
                     newnames = c("resp_x", "resp_y"))%>%
    mutate(stim_attrx = factor(stim_attrx),
             stim_attry = factor(stim_attry))
  
  
  nb_train = length(unique(filter(ave_resp_map_df,stage=="train")$expt_block))
  nb_test = length(unique(filter(ave_resp_map_df,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = ave_resp_map_df%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attry,fill = stim_attry,shape = stim_attrx),size = 3)+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title =paste0("average response map: ", learn_ks[k],'_',generalize_js[j]),
      color = "y feature",shape = "x feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"averagemaps",
                   paste0(learn_ks[k],'_',generalize_js[j],'.png')),plot = p,width = 16,height = 9)
  }
}

```


## response stability
quantify response stability with correlation approach - for each two blocks how correlated are the response (and error)?

#### response
```{r}
stability_df = data.frame()
subid_list = unique(data_with_prob$subid)
for (pid in subid_list){
  #pid = subid_list[1]
  current_data = data_with_prob%>%filter(subid==pid)
  unique_train_blocknum = unique(filter(current_data,stage=="train")$expt_block)
  unique_test_blocknum = unique(filter(current_data,stage=="test")$expt_block)
  nb_train = length(unique_train_blocknum)
  nb_test = length(unique_test_blocknum)
  
  stability_trainx = c()
  stability_trainy = c()
  stability_trainxy = c()
  for (i in seq(2,nb_train,1)){
    j=unique_train_blocknum[i-1]
    k=unique_train_blocknum[i]
    prev_x = arrange(filter(current_data,stage=="train",expt_block==j),stim_id)$resp_x
    prev_y = arrange(filter(current_data,stage=="train",expt_block==j),stim_id)$resp_y
    curr_x = arrange(filter(current_data,stage=="train",expt_block==k),stim_id)$resp_x
    curr_y = arrange(filter(current_data,stage=="train",expt_block==k),stim_id)$resp_y
    
    stability_trainx = append(stability_trainx,cor(prev_x,curr_x))
    stability_trainy = append(stability_trainy,cor(prev_y,curr_y))
    stability_trainxy = append(stability_trainxy,
                             cor(c(prev_x,prev_y), c(curr_x,curr_y)))
  }
  train_stabdf = data.frame(stability_x = stability_trainx,
             stability_y=stability_trainy,
             stability_xy = stability_trainxy,
             expt_block=unique_train_blocknum[2:nb_train])%>%
    mutate(stage="train")
  
  stability_testx = c()
  stability_testy = c()
  stability_testxy = c()
  for (i in seq(2,nb_test,1)){
    j=unique_test_blocknum[i-1]
    k=unique_test_blocknum[i]
    prev_x = arrange(filter(current_data,stage=="test",expt_block==j),stim_id)$resp_x
    prev_y = arrange(filter(current_data,stage=="test",expt_block==j),stim_id)$resp_y
    curr_x = arrange(filter(current_data,stage=="test",expt_block==k),stim_id)$resp_x
    curr_y = arrange(filter(current_data,stage=="test",expt_block==k),stim_id)$resp_y
    
    stability_testx = append(stability_testx,
                             cor(prev_x, curr_x))
    stability_testy = append(stability_testy,
                             cor(prev_y, curr_y))
    stability_testxy = append(stability_testxy,
                             cor(c(prev_x,prev_y), c(curr_x,curr_y)))
  }
  test_stabdf = data.frame(stability_x = stability_testx,
             stability_y=stability_testy,
             stability_xy = stability_testxy,
             expt_block=unique_test_blocknum[2:nb_test])%>%
    mutate(stage="test")
  
  sdf = rbind(train_stabdf,test_stabdf)%>%mutate(
    subid=pid,
    cohort=unique(current_data$cohort),
    islearner=unique(current_data$islearner),
    isgeneralizer=unique(current_data$isgeneralizer))
  
  substab_df = left_join(filter(re_Assign_block,subid==pid,expt_block!=unique_train_blocknum[1],expt_block!=unique_test_blocknum[1]),
                         sdf,
                         by = c("subid", "stage", "expt_block"))
  stability_df = rbind(stability_df,substab_df)
}

```


```{r}
stability_df = stability_df %>%
  mutate(session_str=factor(expt_session, levels = c(1,2,3),labels=c("pretraining","refresher","scanning")))%>%
  mutate(cycle = case_when(stage=="train"&expt_session==1~ceil(blocknumber_withinsess/2),
                           stage=="test"&expt_session==1~blocknumber_withinsess,
                           expt_session==2~blocknumber_withinsess+6,
                           expt_session==3~blocknumber_withinsess+6+3))
  
stability_df_long =stability_df%>%
  filter(cycle>=6)%>%
  pivot_longer(cols=c("stability_x","stability_y","stability_xy"),names_to = "axis",values_to = "stability")%>%
  filter(isgeneralizer=="generalizer"&axis=="stability_xy")%>%
  mutate(stage=factor(stage,levels=c("train","test")))

stability_df_long_sum = stability_df_long%>%
  aggregate_data(yvars = c("stability"),
                 groupbyvars = c("cohort","islearner","isgeneralizer","stage",
                                 "expt_session","cycle","axis"),
                 stats = c("mu","se","n"),
                 additionalvars = c("session_str","expt_block"))
(p = stability_df_long%>%
  ggplot(aes(x=cycle,y=stability,color=cohort))+
  geom_point(alpha = 0.2,size = 2,stroke = 0,position=position_dodge(width=0.5))+
  geom_line(data = stability_df_long_sum,
            aes(x=cycle,y=mu_stability),position=position_dodge(width=0.5))+
  geom_errorbar(data = stability_df_long_sum,
                aes(x=cycle,
                    y = mu_stability,
                    ymin = mu_stability - se_stability,
                    ymax = mu_stability + se_stability),
                width=0.4,position=position_dodge(width=0.5))+
  facet_nested(cols = vars(session_str),
               rows = vars(stage),drop=T,
               independent="x",
               scales = "free_x",space="free_x",axes="all",remove_labels="y")+
  scale_x_continuous(breaks=seq(6,14))+
  labs(x="block number",y="correlation with previous block",color = "cohort",
       title = "response stability of generalizers")+
  theme(aspect.ratio = 1.5,legend.position = "top"))

ggsave(file.path(result_dir,paste0('stability','.png')),plot = p,device = 'png',width = 8,height = 8)
```

#### response error
```{r}
err_stability_df = data.frame()
subid_list = unique(data_with_prob$subid)
for (pid in subid_list){
  current_data = data_with_prob%>%filter(subid==pid)
  unique_train_blocknum = unique(filter(current_data,stage=="train")$expt_block)
  unique_test_blocknum = unique(filter(current_data,stage=="test")$expt_block)
  nb_train = length(unique_train_blocknum)
  nb_test = length(unique_test_blocknum)
  
  stability_trainx = c()
  stability_trainy = c()
  stability_trainxy = c()
  for (i in seq(2,nb_train,1)){
    j=unique_train_blocknum[i-1]
    k=unique_train_blocknum[i]
    prev_x = arrange(filter(current_data,stage=="train",expt_block==j),stim_id)$error_x
    prev_y = arrange(filter(current_data,stage=="train",expt_block==j),stim_id)$error_y
    curr_x = arrange(filter(current_data,stage=="train",expt_block==k),stim_id)$error_x
    curr_y = arrange(filter(current_data,stage=="train",expt_block==k),stim_id)$error_y
    
    stability_trainx = append(stability_trainx,cor(prev_x,curr_x))
    stability_trainy = append(stability_trainy,cor(prev_y,curr_y))
    stability_trainxy = append(stability_trainxy,
                             cor(c(prev_x,prev_y), c(curr_x,curr_y)))
  }
  train_stabdf = data.frame(stability_x = stability_trainx,
             stability_y=stability_trainy,
             stability_xy = stability_trainxy,
             expt_block=unique_train_blocknum[2:nb_train])%>%
    mutate(stage="train")
  
  stability_testx = c()
  stability_testy = c()
  stability_testxy = c()
  for (i in seq(2,nb_test,1)){
    j=unique_test_blocknum[i-1]
    k=unique_test_blocknum[i]
    prev_x = arrange(filter(current_data,stage=="test",expt_block==j),stim_id)$error_x
    prev_y = arrange(filter(current_data,stage=="test",expt_block==j),stim_id)$error_y
    curr_x = arrange(filter(current_data,stage=="test",expt_block==k),stim_id)$error_x
    curr_y = arrange(filter(current_data,stage=="test",expt_block==k),stim_id)$error_y
    
    stability_testx = append(stability_testx,
                             cor(prev_x, curr_x))
    stability_testy = append(stability_testy,
                             cor(prev_y, curr_y))
    stability_testxy = append(stability_testxy,
                             cor(c(prev_x,prev_y), c(curr_x,curr_y)))
  }
  test_stabdf = data.frame(stability_x = stability_testx,
             stability_y=stability_testy,
             stability_xy = stability_testxy,
             expt_block=unique_test_blocknum[2:nb_test])%>%
    mutate(stage="test")
  
  sdf = rbind(train_stabdf,test_stabdf)%>%mutate(
    subid=pid,
    cohort=unique(current_data$cohort),
    islearner=unique(current_data$islearner),
    isgeneralizer=unique(current_data$isgeneralizer))
  
  substab_df = left_join(filter(re_Assign_block,subid==pid,expt_block!=unique_train_blocknum[1],expt_block!=unique_test_blocknum[1]),
                         sdf,
                         by = c("subid", "stage", "expt_block"))
  err_stability_df = rbind(err_stability_df,substab_df)
}

```


```{r}
err_stability_df = err_stability_df %>%
  mutate(session_str=factor(expt_session, levels = c(1,2,3),labels=c("pretraining","refresher","scanning")))%>%
  mutate(cycle = case_when(stage=="train"&expt_session==1~ceil(blocknumber_withinsess/2),
                           stage=="test"&expt_session==1~blocknumber_withinsess,
                           expt_session==2~blocknumber_withinsess+6,
                           expt_session==3~blocknumber_withinsess+6+3))
  
errstability_df_long =err_stability_df%>%
  filter(cycle>=6)%>%
  pivot_longer(cols=c("stability_x","stability_y","stability_xy"),names_to = "axis",values_to = "stability")%>%
  filter(isgeneralizer==1&axis!="stability_xy")

errstability_df_long_sum = errstability_df_long%>%
  aggregate_data(yvars = c("stability"),
                 groupbyvars = c("cohort","islearner","isgeneralizer","stage",
                                 "expt_session","cycle","axis"),
                 stats = c("mu","se","n"),
                 additionalvars = c("session_str","expt_block"))
(p = errstability_df_long%>%
  ggplot(aes(x=cycle,y=stability,color=cohort))+
  geom_point(alpha = 0.2,size = 2,stroke = 0,position=position_dodge(width=0.8))+
  geom_line(data = errstability_df_long_sum,
            aes(x=cycle,y=mu_stability),position=position_dodge(width=0.8))+
  geom_errorbar(data = errstability_df_long_sum,
                aes(x=cycle,
                    y = mu_stability,
                    ymin = mu_stability - se_stability,
                    ymax = mu_stability + se_stability),
                width=0.4,position=position_dodge(width=0.8))+
  geom_col(data = errstability_df_long_sum,
           aes(x=cycle,y = mu_stability),fill=NA,
             position=position_dodge(width=0.8),width=0.6)+
  facet_nested(cols = vars(session_str,stage),
               rows = vars(axis),
               scales = "free_x",space = "free_x")+
  scale_x_continuous(breaks = seq(6,13,1))+
  labs(x="block number",y="mean error stability",color = "cohort",
       title = "performance of learners and generalizers")+
  theme(aspect.ratio = 6,legend.position = "top"))

ggsave(file.path(result_dir,paste0('errstability','.png')),plot = p,device = 'png',width = 10,height = 9)
```

## effect of counting on RT
```{r}
interquatile_r = IQR(log(filter(data_with_prob,expt_session==3&stage=="test")$resp_rt),na.rm=T)
q25 = quantile(log(filter(data_with_prob,expt_session==3&stage=="test")$resp_rt),0.25,na.rm=T)
data_with_prob = data_with_prob%>%
  mutate(resp_rt_rep18 = if_else(resp_rt<0.8,NA,resp_rt))%>% #exclude trials that are too fast
  mutate(resp_rt_ms = resp_rt*1000)%>%
  mutate(startdist = scale(sqrt((start_x-stim_x)**2 + (start_y-stim_y)**2)),
         moveddist = scale(sqrt((start_x-resp_x)**2 + (start_y-resp_y)**2)),
         x_order = as.integer(stim_x*2+3),
         y_order = as.integer(stim_y*2+3),
         resp_rtint = (resp_rt_ms+1000),
         logrt = log(resp_rt_ms),
         logrtint = log(resp_rtint))%>%
  mutate(counting = x_order+y_order)

if(!require(corrr)){
    install.packages("corrr")
}

library(corrr)
rt_corr_quickcheckdf = do.call(
  rbind,
  lapply(filter(data_with_prob, isgeneralizer=="generalizer"&expt_session==3&cohort=="second cohort") %>% 
    group_split(subid),
    function(d){d%>%correlate() %>%focus(resp_rt_ms,moveddist)})
  )%>%
  group_by(term)%>%
  summarise(resp_rt_ms = mean(resp_rt_ms),
            moveddist  = mean(moveddist))
```

```{r}
hasConverged <- function (mm) {
  
  if ( !inherits(mm, "merMod")) stop("Error: must pass a lmerMod object")
  
  retval = NULL
  
  if(is.null(unlist(mm@optinfo$conv$lme4))) {
    retval = 1
  }
  else {
    if (isSingular(mm)) {
      retval = 0
    } else {
      retval = -1
    }
  }
  return(retval)
}
```




```{r}
#c1 = lmer(data = filter(data_with_prob,stage=="test"&expt_session==3&cohort=="first cohort"),
#     "resp_rtint~isgeneralizer*counting+moveddist+LR_trial+(LLR_trial|subid)+(counting|subid)+(moveddis#t|subid)+(1|subid)")

rt_countingformula = "resp_rt_ms~expt_trial+LR_trial+x_order+y_order+moveddist+(1|run:subid)+(1|subid)" # didnt add random slope bc lead to singular fit

Gc1 = lmer(data = filter(data_with_prob,isgeneralizer=="generalizer"&stage=="test"&expt_session==3&cohort=="first cohort"),rt_countingformula)

Gc2 = lmer(data = filter(data_with_prob,isgeneralizer=="generalizer"&stage=="test"&expt_session==3&cohort=="second cohort"),rt_countingformula)

NGc1= lmer(data = filter(data_with_prob,isgeneralizer=="non-generalizer"&stage=="test"&expt_session==3&cohort=="first cohort"),rt_countingformula)

NGc2= lmer(data = filter(data_with_prob,isgeneralizer=="non-generalizer"&stage=="test"&expt_session==3&cohort=="second cohort"),rt_countingformula)

hasConverged(Gc1)
hasConverged(Gc2)
hasConverged(NGc1)
hasConverged(NGc2)
export_summs(Gc1,Gc2,NGc1,NGc2,
             model.names = c("Generalizer\nFirst Cohort","Generalizer\nSecond Cohort",
                             "Non-Generalizer\nFirst Cohort","Non-Generalizer\nSecond Cohort"))
```

```{r}
rt_nocountingformula = "resp_rt_ms~expt_trial+LR_trial+moveddist+(1|run:subid)+(1|subid)"

bGc1 = lmer(data = filter(data_with_prob,isgeneralizer=="generalizer"&stage=="test"&expt_session==3&cohort=="first cohort"),rt_nocountingformula)

bGc2 = lmer(data = filter(data_with_prob,isgeneralizer=="generalizer"&stage=="test"&expt_session==3&cohort=="second cohort"),rt_nocountingformula)

bNGc1= lmer(data = filter(data_with_prob,isgeneralizer=="non-generalizer"&stage=="test"&expt_session==3&cohort=="first cohort"),rt_nocountingformula)

bNGc2= lmer(data = filter(data_with_prob,isgeneralizer=="non-generalizer"&stage=="test"&expt_session==3&cohort=="second cohort"),rt_nocountingformula)

mc_tabnames = c("\n\nGeneralizer\nFirst Cohort","\n\nGeneralizer\nSecond Cohort",
                "\n\nNon-Generalizer\nFirst Cohort","\n\nNon-Generalizer\nSecond Cohort")
mc_dfs  = list(anova(bGc1,Gc1), anova(bGc2,Gc2),
            anova(bNGc1,NGc1), anova(bNGc2,NGc2))
for (j in seq(1,4)){
  writeLines(mc_tabnames[j])
  print(md_table(mc_dfs[[j]],format="simple",row.names=c("without counting","with counting")))
  
}
print(sjPlot::tab_df(anova(bGc1,Gc1),title="Generalizer\nFirst Cohort"),use.viewer=F)
print(sjPlot::tab_df(anova(bGc2, Gc2),title="Generalizer\nSecond Cohort"),use.viewer=F)
print(sjPlot::tab_df(anova(bNGc1, NGc1),title="Non-Generalizer\nFirst Cohort"),use.viewer=F)
print(sjPlot::tab_df(anova(bNGc2, NGc2),title="Non-Generalizer\nSecond Cohort"),use.viewer=F)

```


```{r}

rt_countingformula = "resp_rt_ms~expt_trial+LR_trial+x_order+y_order+moveddist+(1|subid:run)+(-1+y_order|subid)+(-1+x_order|subid)+(1|subid)" # didnt add random slope bc lead to singular fit
#isgeneralizer=="generalizer"
G_C1C2 = lmer(data = filter(data_with_prob,isgeneralizer=="generalizer"&stage=="test"&expt_session==3),rt_countingformula)

hasConverged((G_C1C2))

ranef(G_C1C2)$subid
```


```{r}

data_with_prob = data_with_prob%>%
  mutate(cycle=case_when(expt_session==1&stage=="train"~ceil(blocknumber_withinsess/4),
                         expt_session==1&stage=="test"~ceil(blocknumber_withinsess/2),
                         expt_session==2~NA,
                         expt_session==3&blocknumber_withinsess%in%c(1,3)~3+1,
                         expt_session==3&blocknumber_withinsess%in%c(2,4)~3+1))
cal_unexpvar = function(d,rtvar){
  f = paste0(rtvar,"~moveddist+expt_trial+LR_trial")
  m = lm(f,data=d)
  uev = 1-summary(m)[["r.squared"]]
  
  return(list(resid=m[["residuals"]],uev=uev))
}

cal_counting_coef = function(d,rtvar){
  f2 = paste0(rtvar,"~moveddist+expt_trial+LR_trial+x_order+y_order")
  m2 = lm(f2,data=d)
  m2_coef_sum = summary(m2)[["coefficients"]]
  df = data.frame(m2_coef_sum)%>%
    change_cols_name(c("Estimate","Std..Error","t.value","Pr...t.."),c("est","std","t","p"))
  df[["IV"]] = unlist(lapply(row.names(df),function(x){str_remove_all(x,"[()]")}))
  m2_coef_sum = df%>%pivot_longer(cols=c("est","std","t","p"),names_to="stat")
  return(m2_coef_sum)
}

rtresid_dfs = lapply(
  group_split(filter(data_with_prob,expt_session==3&stage=="test"),cohort,islearner,isgeneralizer,subid,stage), 
  function(d){
        d = d%>%dplyr::select(-c("Unnamed..0","X"))%>%filter(!is.na(resp_rt_ms))
        if(nrow(d)>1){
          resid_op = cal_unexpvar(d,"resp_rt_ms")
          d[["rt_resid"]] = resid_op[["resid"]]
        } 
      return(d)  
      }
)
rt_afterdist_resid_df = do.call(rbind,rtresid_dfs)

substageblock_data_splits = group_split(filter(data_with_prob,!is.na(cycle)&stage=="test"),
                                        subid,cycle,stage)
rtcoef_dfs = lapply(
  substageblock_data_splits, 
  function(d){
        d = d%>%dplyr::select(-c("Unnamed..0","X"))%>%filter(!is.na(resp_rt_ms))
        if(nrow(d)>1){
          coef_sum = cal_counting_coef(d,"resp_rt_ms")
          iddf = d%>%distinct(cohort,islearner,isgeneralizer,subid,stage,cycle)
          coef_sum = cbind(iddf[rep(1, each = nrow(coef_sum)), ],coef_sum)
          return(coef_sum)  
        } 
      }
)        
rt_coef_df = do.call(rbind,rtcoef_dfs)

```


```{r,fig.width=6}
rt_counting_coef_sub_cycle = rt_coef_df%>%
  filter(IV%in%c("x_order","y_order")&stat=="est")%>%
  mutate(IV = factor(IV,levels=c("x_order","y_order"),labels=c("x","y")))%>%
  pivot_wider(id_cols = c("cohort","islearner","isgeneralizer","subid","stage","cycle"),
              values_from = "value", names_from ="IV")%>%
  mutate(tamapping = if_else(sign(x)==sign(y),1,-1))%>%
  mutate(tamapping_weight = tamapping*0.5*((abs(x)+abs(y))))         

rt_counting_coef_sub_cycle_wide = rt_counting_coef_sub_cycle%>%
  pivot_wider(id_cols = c("cohort","islearner","isgeneralizer","subid","stage"),
              values_from = "tamapping", names_from ="cycle",names_prefix = "tamapping_")

rt_counting_coef_sub_cycle_wide%>%
  mutate(lstr=if_else(sign(tamapping_3)!=sign(tamapping_4),subid,""),
         jitterx = tamapping_3+runif(nrow(rt_counting_coef_sub_cycle_wide),-0.3,0.3),
         jittery = tamapping_4+runif(nrow(rt_counting_coef_sub_cycle_wide),-0.3,0.3))%>%
ggplot(aes(y=jitterx,x=jittery,color=cohort))+
  facet_wrap2(vars(isgeneralizer),nrow=2,axes="all")+
  #geom_jitter(width=0.4,height=0.4,alpha=0.8)+
  geom_point(alpha=0.8)+
  geom_hline(yintercept=0,linetype ="dashed")+
  geom_vline(xintercept=0,linetype ="dashed")+
  labs(y="scanning", x = "pretraining")+
  scale_x_continuous(breaks=c(1,-1),labels=c("top-left","top-right"),limits = c(-1.5,1.5))+
  scale_y_continuous(breaks=c(1,-1),labels=c("top-left","top-right"),limits = c(-1.5,1.5))+
  theme(panel.border=element_rect(fill = NA),
        legend.position = "top")+
  geom_text(x=-0.8,y=0.31,label="inconsistent",color="darkgrey")+
  geom_text(x=0.8,y=-0.31,label="inconsistent",color="darkgrey")+
  geom_text(x=0.8,y=0.31,label="top-left",color="darkgrey")+
  geom_text(x=-0.8,y=-0.31,label="top-right",color="darkgrey")#+
#  geom_text(aes(label=lstr),size=2)


training_axis_mapping = rt_counting_coef_sub_cycle_wide%>%
  filter(stage=="test")%>%
  mutate(tamapping = case_when(
    tamapping_4==tamapping_3~tamapping_4, #(countx_p<0.05)&(county_p<0.05) 
    tamapping_4!=tamapping_3~0)
    )%>%
  mutate(tamapping_str = factor(tamapping,levels=c(1,-1,0),labels=c("topleft","topright","inconsistent")))
ggplot(training_axis_mapping,
       aes(x=tamapping_str,color=cohort))+
  facet_grid(cols=vars(isgeneralizer))+
  geom_bar(position=position_dodge(),fill=NA)


```


```{r}
rt_counting_coef_sub = rt_coef_df%>%
  filter(IV%in%c("x_order","y_order")&stage=="test"&cycle==4)%>%
  dplyr::select(-c("stage","cycle"))%>%
  pivot_wider(id_cols = c("cohort","IV","islearner","isgeneralizer","subid"),
              values_from = "value", names_from ="stat")%>%
  change_cols_name("est","regcoef")

rt_counting_coef_sum = rt_counting_coef_sub%>%
  aggregate_data(groupbyvars = c("cohort","islearner","isgeneralizer","IV"),
                 yvars = "regcoef",
                 stats=c("mu"))

rt_counting_coef_sub_wide = rt_counting_coef_sub%>%
  pivot_wider(id_cols = c("cohort","islearner","isgeneralizer","subid"),
              values_from = "regcoef",
              names_from ="IV")
ggplot(rt_counting_coef_sub_wide,aes(x=x_order  ,y=y_order  ,color=cohort))+
  facet_grid(cols=vars(isgeneralizer))+
  geom_point()+
  geom_hline(yintercept=0,linetype="dashed")+
  geom_vline(xintercept=0,linetype="dashed")+
  labs(x="Beta_stimx",y="Beta_stimy")+
  theme(legend.position="top")

rt_counting_coefwithp_sub = rt_counting_coef_sub%>%
  pivot_wider(id_cols=c("cohort","islearner","isgeneralizer","subid"),
              values_from = c("regcoef","p"),
              names_from = "IV")%>%
  change_cols_name(c("regcoef_x_order","regcoef_y_order","p_x_order","p_y_order"),
                   c("countx_coef","county_coef","countx_p","county_p"))

#nrow(rt_coef_df_wide) == length(unique(scanning_beh$subid))
#nrow(rt_counting_coefwithp_sub) == length(unique(scanning_beh$subid))

training_axis_mapping = rt_counting_coefwithp_sub%>%
  mutate(tamapping = case_when(
    sign(countx_coef)==sign(county_coef)~1, #(countx_p<0.05)&(county_p<0.05) 
    sign(countx_coef)!=sign(county_coef)~-1, # abs(countx_coef)>11.57369&abs(county_coef)>10.10267&
    .default = 0)
    )%>%
  mutate(tamapping_str = factor(tamapping,levels=c(1,-1,0),labels=c("topleft","topright","orthogonal")),
       ave_abs_count_coef = (abs(countx_coef)+abs(countx_coef))/2)%>%
  dplyr::select(c("cohort","islearner","isgeneralizer","subid","tamapping","tamapping_str",
                  "countx_coef","county_coef","ave_abs_count_coef","countx_p","county_p"))

ggplot(training_axis_mapping,aes(x=tamapping_str,color=isgeneralizer))+geom_bar(position=position_dodge(),fill=NA)
```





```{r}
rt_counting_coef_sub_long = rt_counting_coef_sub%>%
  mutate(countaxis = factor(IV,levels=c("x_order","y_order"),labels=c("count x","count y")),
         absregcoef = abs(regcoef))

rt_counting_coef_sum_long = rt_counting_coef_sub_long%>%
  aggregate_data(groupbyvars=c("cohort","isgeneralizer", "countaxis"),
                 yvars=c("regcoef","absregcoef"),
                 stats=c("mu","se"))

ggplot(data=rt_counting_coef_sub_long,
       aes(x=isgeneralizer,color=countaxis))+
  facet_nested(cols=vars(cohort),
               scale="free_x")+
  geom_point(aes(y=regcoef),
             alpha=0.5,
             position=position_jitterdodge(jitter.width=0.2,dodge.width = 0.9)
             #position=position_dodge(width=0.9)
           )+
  geom_col(data = rt_counting_coef_sum_long,
           aes(y=mu_regcoef),
           #method = "lm",se=F,na.rm = T,formula='y ~ x',
           position=position_dodge(width=0.9),
           fill=NA)+
  geom_point(data = rt_counting_coef_sum_long, 
           aes(y=mu_regcoef),
           position=position_dodge(width=0.9)
           )+
  geom_errorbar(data = rt_counting_coef_sum_long, 
           aes(ymin=mu_regcoef-se_regcoef,
               ymax=mu_regcoef+se_regcoef),
           position=position_dodge(width=0.9),
           width=0.4)+
  labs(y="regression coefficient of counting")+
  theme(legend.position = "top",legend.direction = "horizontal",
        aspect.ratio = 1)

ggplot(data=rt_counting_coef_sub_long,
       aes(x=isgeneralizer,color=countaxis))+
  facet_nested(cols=vars(cohort),
               scale="free_x")+
  geom_point(aes(y=absregcoef),
             alpha=0.5,
             position=position_jitterdodge(jitter.width=0.2,dodge.width = 0.9)
             #position=position_dodge(width=0.9)
           )+
  geom_col(data = rt_counting_coef_sum_long,
           aes(y=mu_absregcoef),
           #method = "lm",se=F,na.rm = T,formula='y ~ x',
           position=position_dodge(width=0.9),
           fill=NA)+
  geom_point(data = rt_counting_coef_sum_long, 
           aes(y=mu_absregcoef),
           position=position_dodge(width=0.9)
           )+
  geom_errorbar(data = rt_counting_coef_sum_long, 
           aes(ymin=mu_absregcoef-se_absregcoef,
               ymax=mu_absregcoef+se_absregcoef),
           position=position_dodge(width=0.9),
           width=0.4)+
  labs(y="abs regression coefficient of counting")+
  theme(legend.position = "top",legend.direction = "horizontal",
        aspect.ratio = 1)


```





```{r}
scanning_beh = meanscanperf_with_prob%>%
  dplyr::select(-c(starts_with("UND"),starts_with("BND"),starts_with("pnorm"),starts_with("binorm"),starts_with("uniform")))

write_csv(scanning_beh,
          file.path(data_dir,"scanner_stim_LLR.csv"))


# rt_counting_coef_sub_long%>%
#   filter(isgeneralizer=="generalizer")%>%
#   aggregate_data(groupbyvars=c( "countaxis"),
#                  yvars=c("absregcoef"),
#                  stats=c("mu","se"))%>%
#   mutate(criteria = se_absregcoef)
# 
# #ggplot(training_axis_mapping,aes(x=tamapping_str,color=isgeneralizer))+geom_bar(position=position_dodge(),fill=NA)


scanning_aveperf = scanning_beh%>%
  aggregate_data(groupbyvars = c("cohort","subid","stage"),
                 yvars = "LLR_trial",
                 stats="mu")%>%
  change_cols_name("mu_LLR_trial","LLR")%>%
  pivot_wider(id_cols=c("cohort","subid"),names_from = "stage",names_prefix="LLR_",values_from ="LLR")
scanning_aveperf = left_join(training_axis_mapping,scanning_aveperf,
                             by=c("cohort","subid"))
write_csv(scanning_aveperf,
          file.path(data_dir,"scanner_average_LLR_wmapping.csv"))

```

```{r}
rt_countingformula = "resp_rt_ms~expt_trial+LR_trial+x_order+y_order+moveddist+(1|run:subid)+(-1+x_order|subid)+(-1+y_order|subid)" # didnt add random slope bc lead to singular fit
rt_fitG = lmer(data = filter(data_with_prob,stage=="test"&expt_session==3&isgeneralizer=="generalizer"),rt_countingformula)
rt_fitnG = lmer(data = filter(data_with_prob,stage=="test"&expt_session==3&isgeneralizer=="non-generalizer"),rt_countingformula)

rt_countingformula = "resp_rt_ms~isgeneralizer+x_order+y_order+expt_trial+LR_trial+moveddist+(1|run:subid)+(-1+x_order|subid)+(-1+y_order|subid)" # didnt add random slope bc lead to singular fit
rt_fitall = lmer(data = filter(data_with_prob,stage=="test"&expt_session==3),rt_countingformula)

hasConverged(rt_fitG)
hasConverged(rt_fitnG)
hasConverged(rt_fitall)
export_summs(rt_fitnG,rt_fitnG,model.names=c("Generalizers","nonGeneralizers"))

rtcountxy_coef_df1 =  data.frame(ranef(rt_fitG)$subid)
rtcountxy_coef_df1["subid"] = row.names(rtcountxy_coef_df1)
rtcountxy_coef_df2 =  data.frame(ranef(rt_fitnG)$subid)
rtcountxy_coef_df2["subid"] = row.names(rtcountxy_coef_df2)
rtcountxy_coef_df = rbind(rtcountxy_coef_df1,rtcountxy_coef_df2)

rtcountxy_coef_df =  data.frame(ranef(rt_fitall)$subid)
rtcountxy_coef_df["subid"] = row.names(rtcountxy_coef_df)

rtcountxy_coef_df = rtcountxy_coef_df%>%
  mutate(isgeneralizer=if_else(subid%in%generalizerids,"generalizer","non-generalizer"),
         cohort = if_else(str_starts(subid,"sub0"),"first cohort","second cohort"))

ggplot(rtcountxy_coef_df,aes(x=x_order,y=y_order,color=cohort))+
  facet_grid(cols=vars(isgeneralizer))+
  geom_point()+
  geom_vline(xintercept=0)+
  geom_hline(yintercept=0)

ggplot(rtcountxy_coef_df,aes(x=isgeneralizer,y=abs(x_order),color=cohort))+
  geom_point()


training_axis_mapping = rtcountxy_coef_df%>%
  change_cols_name(c("x_order","y_order"),c("countx_coef","county_coef"))%>%
  mutate(tamapping = case_when(
    sign(countx_coef)==sign(county_coef)~1, #(countx_p<0.05)&(county_p<0.05) 
    sign(countx_coef)!=sign(county_coef)~-1, # abs(countx_coef)>11.57369&abs(county_coef)>10.10267&
    .default = 0)
    )%>%
  mutate(tamapping_str = factor(tamapping,levels=c(1,-1,0),labels=c("topleft","topright","orthogonal")),
       ave_abs_count_coef = (abs(countx_coef)+abs(countx_coef))/2)%>%
  dplyr::select(c("cohort","islearner","isgeneralizer","subid","tamapping","tamapping_str",
                  "countx_coef","county_coef","ave_abs_count_coef","countx_p","county_p"))
ggplot(training_axis_mapping,aes(x=tamapping_str,color=isgeneralizer))+geom_bar(position=position_dodge(),fill=NA)

scanning_aveperf = scanning_beh%>%
  aggregate_data(groupbyvars = c("cohort","subid","stage"),
                 yvars = "LLR_trial",
                 stats="mu")%>%
  change_cols_name("mu_LLR_trial","LLR")%>%
  pivot_wider(id_cols=c("cohort","subid"),names_from = "stage",names_prefix="LLR_",values_from ="LLR")
scanning_aveperf = left_join(training_axis_mapping,scanning_aveperf,
                             by=c("cohort","subid"))
write_csv(scanning_aveperf,
          file.path(data_dir,"scanner_average_LLR_wmapping.csv"))

```


```{r}
rt_afterdist_resid_sub = rt_afterdist_resid_df%>%
  mutate(cycle = case_when(stage=="train"&expt_session==1~ceil(blocknumber_withinsess/2),
                           stage=="test"&expt_session==1~blocknumber_withinsess,
                           expt_session==2~blocknumber_withinsess+6,
                           expt_session==3~blocknumber_withinsess+6+3))%>%
  filter(cycle>=6)%>%
  #mutate(x_order=factor(x_order),
         #y_order=factor(y_order),
         #counting=factor(counting)
  #       )%>%
  aggregate_data(groupbyvars = c("cohort","islearner","isgeneralizer","subid",
                                 "session_str",
                                 "stage","counting"),
                 yvars = c("rt_resid","rtint_resid","logrt_resid","logrtint_resid"),
                 stats = c("mu","n"))%>%
  change_cols_name(c("mu_rt_resid","mu_rtint_resid","mu_logrt_resid","mu_logrtint_resid"),
                   c("rt_resid","rtint_resid","logrt_resid","logrtint_resid"))%>%
  filter(session_str == "scanning"&stage=="test")

rt_afterdist_resid_sum = rt_afterdist_resid_sub%>%
  aggregate_data(groupbyvars = c("cohort","isgeneralizer",
                                 "session_str",
                                 "stage","counting"),
                 yvars = c("rt_resid","rtint_resid","logrt_resid","logrtint_resid"),
                 stats = c("mu","se"))

ggplot(data=filter(rt_afterdist_resid_sub),
       aes(x=counting,color=cohort))+
  facet_nested(cols=vars(isgeneralizer),
               rows=vars(stage),
               scale="free_x")+
  # geom_smooth(aes(y=rt_resid,group=subid),
  #            alpha=0.01,linewidth=0.1,
  #            method = "lm",se=F,na.rm = T,formula='y ~ x',
  #             )+
  geom_point(aes(y=rt_resid),
             alpha=0.2,
             #position=position_jitterdodge(jitter.width=0.2,dodge.width = 0.9)
             position=position_dodge(width=0.6)
           )+
  geom_line(data = rt_afterdist_resid_sum,
           aes(y=mu_rt_resid),
           #method = "lm",se=F,na.rm = T,formula='y ~ x',
           position=position_dodge(width=0.6)
           )+
  geom_point(data = rt_afterdist_resid_sum, 
           aes(y=mu_rt_resid),
           position=position_dodge(width=0.6)
           )+
  geom_errorbar(data = rt_afterdist_resid_sum, 
           aes(ymin=mu_rt_resid-se_rt_resid,
               ymax=mu_rt_resid+se_rt_resid),
           position=position_dodge(width=0.6),
           width=0.4)+
  theme(legend.position = "top",legend.direction = "horizontal",
        aspect.ratio = 2)
  

```












## compute correlation with groundtruth map using CCA
```{r}
cca_df = data_with_prob%>%distinct(subid,stage,session_str,blocknumber_withinsess)

cl<- makeCluster(detectCores())
clusterExport(cl=cl,
              varlist = c("cca_df","data_with_prob"),
              envir=environment())
cc_res <- pblapply(cl = cl,X = seq(1,nrow(cca_df)),FUN = function(j){
  config = cca_df[j,]
  current_data = dplyr::left_join(cca_df[j,],data_with_prob)
  groundtruth = dplyr::select(current_data,c("stim_x","stim_y"))
  participant = dplyr::select(current_data,c("resp_x","resp_y"))
  cc <- cancor(groundtruth, participant)
  return(cc)
})
stopCluster(cl)

cca_df = cbind(cca_df,
      do.call(rbind,lapply(cc_res,FUN = function(cc){
                            df = data.frame(t(cc$cor))
                            colnames(df) = c("corrcoef1","corrcoef2")
                            return(df)
                          })
        )
      )
head(cca_df)
```


```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attrx,fill = stim_attrx,shape = stim_attry),size = 3)+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=1.6,label = sprintf("LLR = %s", formatC(LLR, digits = 2))))+
    geom_text(data = filter(cca_df, subid == pid),size = 3,
              aes(x=0.1,y=2,
                  label = sprintf("CCA: [%s, %s]",
                                  formatC(corrcoef1, digits = 2),
                                  formatC(corrcoef2, digits = 2))))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+ #RColorBrewer::brewer.pal(5, "Dark2"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "x feature",shape = "y feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"participant_map_withLLRCCA",paste0(pid,'.png')),plot = p,width = 16,height = 9)
  
}
```

## compute correlation with groundtruth map using regression

```{r}
reg_df = data_with_prob%>%distinct(subid,stage,session_str,blocknumber_withinsess)

cl<- makeCluster(detectCores())
clusterExport(cl=cl,
              varlist = c("reg_df","data_with_prob","change_cols_name"),
              envir=environment())
reg_res <- pblapply(cl = cl,X = seq(1,nrow(reg_df)),FUN = function(j){
  library(dplyr)
  config = reg_df[j,]
  current_data = dplyr::left_join(reg_df[j,],data_with_prob)%>%
    mutate(resp_x = scale(resp_x),
           resp_y = scale(resp_y),
           stim_x = scale(stim_x),
           stim_y = scale(stim_y))
  resx = lm(resp_x~stim_x,current_data)
  resy = lm(resp_y~stim_y,current_data)
  sumx = summary(resx)
  sumy = summary(resy)
  
  df_x = data.frame(t(sumx[["fstatistic"]]))%>%
    mutate(p = pf(sumx$fstatistic[1],sumx$fstatistic[2],sumx$fstatistic[3],lower.tail=FALSE))%>%
    change_cols_name(oldnames = colnames(.),newnames = c("Fvalue_x","Fnumdf_x","Fdendf_x","Fpvalue_x"))%>%
    mutate(coef_x = resx[["coefficients"]][["stim_x"]])
  
  df_y = data.frame(t(sumy[["fstatistic"]]))%>%
    mutate(p = pf(sumy$fstatistic[1],sumy$fstatistic[2],sumy$fstatistic[3],lower.tail=FALSE))%>%
    change_cols_name(oldnames = colnames(.),newnames = c("Fvalue_y","Fnumdf_y","Fdendf_y","Fpvalue_y"))%>%
    mutate(coef_y = resy[["coefficients"]][["stim_y"]])

  df <- cbind(df_x,df_y)
  return(df)
})
stopCluster(cl)

reg_df = data_with_prob%>%distinct(subid,stage,session_str,blocknumber_withinsess)
reg_df = cbind(reg_df,
               do.call(rbind,reg_res))%>%
  mutate(sigif_1Dx = case_when(Fpvalue_x>=0.05~sprintf("%.2f%s",coef_x,""),
                               Fpvalue_x>=0.01 & Fpvalue_x<0.05~sprintf("%.2f%s",coef_x,"*"),
                               Fpvalue_x>=0.001 & Fpvalue_x<0.01~sprintf("%.2f%s",coef_x,"**"),
                               Fpvalue_x<0.001~sprintf("%.2f%s",coef_x,"***")),
         
         sigif_1Dy = case_when(Fpvalue_y>=0.05~sprintf("%.2f%s",coef_y,""),
                               Fpvalue_y>=0.01 & Fpvalue_y<0.05~sprintf("%.2f%s",coef_y,"*"),
                               Fpvalue_y>=0.001 & Fpvalue_y<0.01~sprintf("%.2f%s",coef_y,"**"),
                               Fpvalue_y<0.001~sprintf("%.2f%s",coef_y,"***")))%>%
  mutate(textcoef1D = paste0("\u03b2x = ",sigif_1Dx,", \u03b2y = ",sigif_1Dy)
        )
head(reg_df)
```

```{r}
for (pid in unique(filter(data_with_prob)$subid)){
  current_data = filter(data_with_prob,subid == pid)%>%
    mutate(stim_attrx = factor(stim_attrx),
           stim_attry = factor(stim_attry),
           islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
           isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
  
  psub.title = paste(pid,unique(current_data$islearner),unique(current_data$isgeneralizer))
  nb_train = length(unique(filter(current_data,stage=="train")$expt_block))
  nb_test = length(unique(filter(current_data,stage=="test")$expt_block))
  layoutmat = matrix(c(seq(1,10),
                       seq(11,nb_train), rep(NA,20-nb_train),
                       seq(nb_train+1,nb_train+nb_test)),
                     3, 10, byrow = TRUE)
  (p = current_data%>%
    ggplot(aes(x=resp_x, y = resp_y))+
    facet_manual(vars(stage,session_str,blocknumber_withinsess),design = layoutmat,strip = strip_nested())+
    geom_point(aes(color = stim_attrx,fill = stim_attrx,shape = stim_attry),size = 3)+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 3,
              aes(x=0.1,y=2.1,label = sprintf("LLR = %s", formatC(LLR, digits = 2))))+
    geom_text(data = filter(blockdata_sub, subid == pid),size = 2.5,
              aes(x=0.1,y=1.85,
                  label = sprintf("1D LLR(x,y): [%s, %s]",
                                  formatC(LLR_x, digits = 2),
                                  formatC(LLR_y, digits = 2))))+
    geom_text(data = filter(reg_df, subid == pid),size = 2.5,
                  fill = NA, label.color = NA,label.padding = grid::unit(rep(0, 4), "pt"),
                  aes(x=0,y=1.6,label = textcoef1D))+
    scale_color_manual(values = y_colors,aesthetics = c("color","fill"))+
    scale_shape_manual(values = x_shapes)+
    guides(fill = "none")+
    labs(title = psub.title,
         color = "x feature",shape = "y feature", x = "x", y = "y")+
    theme(legend.position = "top"))
  ggsave(file.path(result_dir,'individualmaps',"participant_map_with1dcoef",paste0(pid,'.png')),plot = p,width = 16,height = 9)
  
}
```



# Error Analysis
```{r}
data_with_prob =
  data_with_prob%>%
  mutate(resp_samexsign = sign(resp_x) == sign(stim_x),
         resp_sameysign = sign(resp_y) == sign(stim_y)
         )%>%
  mutate(resp_samequad = resp_samexsign & resp_sameysign)
err_blocksum = data_with_prob%>%
  filter(abs(stim_x)==0.5, abs(stim_y)==0.5)%>%
  aggregate_data(
    yvars = c("resp_samexsign","resp_sameysign","resp_samequad"),
    groupbyvars = c("subid","stage","expt_session","blocknumber_withinsess"),
    stats = c("mu"),
    additionalvars = c("islearner","isgeneralizer","session_str")
  )%>%
  change_cols_name(oldnames = c("mu_resp_samexsign","mu_resp_sameysign","mu_resp_samequad"),
                   newnames = c("resp_samexsign","resp_sameysign","resp_samequad"))%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))
err_groupsum = err_blocksum %>%
  aggregate_data(
    yvars = c("resp_samexsign","resp_sameysign","resp_samequad"),
    groupbyvars = c("stage","expt_session","blocknumber_withinsess","islearner","isgeneralizer"),
    stats = c("mu","se"),
    additionalvars = c("session_str")
  )
```

```{r}
p_err = err_blocksum %>%
  ggplot(aes(x=blocknumber_withinsess,y=resp_samequad))+
  geom_point(alpha = 0.3,size = 2,stroke=0)+
  geom_line(data = err_groupsum,
            aes(x=blocknumber_withinsess,y=mu_resp_samequad))+
  geom_errorbar(data = err_groupsum,
                aes(x=blocknumber_withinsess,
                    y = mu_resp_samequad,
                    ymin = mu_resp_samequad - se_resp_samequad,
                    ymax = mu_resp_samequad + se_resp_samequad),
                width=0.4)+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x")+
  scale_x_continuous(breaks = seq(1,6,1))+
  labs(x="block number",y="percentage of error in the same quadrant",color = "curriculum",
       title = "performance of learners and generalizers")+
  theme(aspect.ratio = 2,legend.position = "top")
ggsave(file.path(result_dir,paste0('errors','.png')),plot = p_err,device = 'png',width = 10,height = 9)
```

# Correlation of behavior with different model RDM throughout training

```{r}
keepcols = c("subid","stage","session_str","blocknumber_withinsess",
             "islearner","isgeneralizer")
reg_df = data_with_prob%>%distinct(subid,stage,session_str,blocknumber_withinsess,.keep_all = TRUE)%>%
  dplyr::select(all_of(keepcols))

cl<- makeCluster(detectCores())
clusterExport(cl=cl,
              varlist = c("reg_df","data_with_prob","change_cols_name"),
              envir=environment())
reg_res <- pblapply(cl = cl,X = seq(1,nrow(reg_df)),FUN = function(j){
  library(dplyr)
  config = reg_df[j,]
  curr_df = dplyr::left_join(config,data_with_prob)%>%
              arrange(stim_id)
  resp_loc = cbind(curr_df[["resp_x"]],curr_df[["resp_y"]])
  attrx_onehot = model.matrix(~factor(stim_attrx)-1,curr_df)
  attry_onehot = model.matrix(~factor(stim_attry)-1,curr_df)
  theo_loc = list(
    stim_x = curr_df[["stim_x"]],
    stim_y = curr_df[["stim_y"]],
    feature_x = attrx_onehot,
    feature_y = attry_onehot,
    global_x = sign(curr_df[["stim_x"]]),
    global_y = sign(curr_df[["stim_y"]]),
    local_x = abs(curr_df[["stim_x"]]),
    local_y = abs(curr_df[["stim_y"]]),
    cartesian_2D = cbind(curr_df[["stim_x"]],curr_df[["stim_y"]]),
    feature_2D = cbind(attrx_onehot,attry_onehot),
    hierarchical_global = sign(cbind(curr_df[["stim_x"]],curr_df[["stim_y"]])),
    hierarchical_local = abs(cbind(curr_df[["stim_x"]],curr_df[["stim_y"]]))
  )
  
  theo_rdm = list()
  rdms = list()
  for (theo_name in names(theo_loc)){
    theo_rdm[[theo_name]] = dist(theo_loc[[theo_name]], method = "euclidean")
    rdms[[theo_name]] = scale(c(theo_rdm[[theo_name]]), scale = TRUE)
  }
  resp_rdm = dist(resp_loc, method = "euclidean")
  #heatmap(as.matrix(resp_rdm),Rowv = NA, Colv = NA)
  rdms[["response"]] = c(resp_rdm)
  rdm_df = data.frame(rdms)
  rdm_reg = lm(response~cartesian_2D+feature_2D+hierarchical_global+hierarchical_local,rdm_df)
  #rdm_reg = lm(response~stim_x+stim_y+feature_x+feature_y+
  #               global_x+global_y+local_x+local_y,rdm_df)
  reg_res_df = data.frame(rdm_reg$coefficients)
  reg_res_df["coefficient"] = row.names(reg_res_df)
  row.names(reg_res_df) = NULL
  
  df = cbind(reg_res_df, reg_df[j,][rep(1,nrow(reg_res_df)),])
  return(df)
})
stopCluster(cl)
```




```{r}
reg_rdm_df = do.call(rbind,reg_res)%>%
  change_cols_name(oldnames = c("rdm_reg.coefficients","coefficient"),
                   newnames = c("coef","modelrdm"))%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))%>%
  filter(modelrdm!="(Intercept)")

colnames(reg_rdm_df)
reg_rdm_df_agg = 
  aggregate_data(reg_rdm_df,
     yvars= c("coef"),
     groupbyvars = c("islearner","isgeneralizer","stage",
                     "blocknumber_withinsess","modelrdm"),
     stats = c("mu","se","n"),
     additionalvars = c("session_str")
  )

ggplot(data=reg_rdm_df_agg,aes(x=blocknumber_withinsess,color=modelrdm))+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x")+
  geom_line(aes(y=mu_coef))+
  geom_errorbar(aes(ymin = mu_coef - se_coef,
                    ymax = mu_coef + se_coef),
                width=0.4)+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean coef",color = "modelrdm",
       title = "performance of learners and generalizers")+
  theme(aspect.ratio = 3,legend.position = "top")
```




```{r}
keepcols = c("subid","stage","session_str","blocknumber_withinsess",
             "islearner","isgeneralizer")
reg_df = data_with_prob%>%distinct(subid,stage,session_str,blocknumber_withinsess,.keep_all = TRUE)%>%
  dplyr::select(all_of(keepcols))

cl<- makeCluster(detectCores())
clusterExport(cl=cl,
              varlist = c("reg_df","data_with_prob","change_cols_name"),
              envir=environment())
reg_res <- pblapply(cl = cl,X = seq(1,nrow(reg_df)),FUN = function(j){
  library(dplyr)
  
  library(tidyr)
  config = reg_df[j,]
  curr_df = dplyr::left_join(config,data_with_prob)%>%
              arrange(stim_id)
  resp_loc = cbind(curr_df[["resp_x"]],curr_df[["resp_y"]])
  attrx_onehot = model.matrix(~factor(stim_attrx)-1,curr_df)
  attry_onehot = model.matrix(~factor(stim_attry)-1,curr_df)
  theo_loc = list(
    stim_x = curr_df[["stim_x"]],
    stim_y = curr_df[["stim_y"]],
    feature_x = attrx_onehot,
    feature_y = attry_onehot,
    global_x = sign(curr_df[["stim_x"]]),
    global_y = sign(curr_df[["stim_y"]]),
    local_x = abs(curr_df[["stim_x"]]),
    local_y = abs(curr_df[["stim_y"]]),
    cartesian_2D = cbind(curr_df[["stim_x"]],curr_df[["stim_y"]]),
    feature_2D = cbind(attrx_onehot,attry_onehot),
    hierarchical_global = sign(cbind(curr_df[["stim_x"]],curr_df[["stim_y"]])),
    hierarchical_local = abs(cbind(curr_df[["stim_x"]],curr_df[["stim_y"]]))
  )
  
  theo_rdm = list()
  rdms = list()
  for (theo_name in names(theo_loc)){
    theo_rdm[[theo_name]] = dist(theo_loc[[theo_name]], method = "euclidean")
    rdms[[theo_name]] = scale(c(theo_rdm[[theo_name]]), scale = TRUE)
  }
  resp_rdm = dist(resp_loc, method = "euclidean")
  #heatmap(as.matrix(resp_rdm),Rowv = NA, Colv = NA)
  rdms[["response"]] = c(resp_rdm)
  rdm_df = data.frame(rdms)
  reg_models = list(
    cartesian_2D_combine = lm(response~cartesian_2D,rdm_df),
    feature_10D_combine = lm(response~feature_2D,rdm_df),
    hierarchical_4D_combine = lm(response~hierarchical_global+hierarchical_local,rdm_df),
    cartesian_2D_separate = lm(response~stim_x+stim_y,rdm_df),
    feature_10D_separate = lm(response~feature_x+feature_y,rdm_df),
    hierarchical_4D_separate = lm(response~global_x+global_y+local_x+local_y,rdm_df)
  )
  rs  = list()
  ars = list()
  aic = list()
  bic = list()
  for (theo_name in names(reg_models)){
    rs[[theo_name]] = summary(reg_models[[theo_name]])[["r.squared"]]
    ars[[theo_name]] = summary(reg_models[[theo_name]])[["adj.r.squared"]]
    aic[[theo_name]] = AIC(reg_models[[theo_name]])
    bic[[theo_name]] = BIC(reg_models[[theo_name]])
  }

  rsquardf = left_join(
    pivot_longer(data.frame(rs),cols = names(reg_models),names_to ="modelrdm",values_to = "Rsquare"),
    pivot_longer(data.frame(ars),cols = names(reg_models),names_to ="modelrdm",values_to = "adjustedRsquare")
  )
  
  icdf = left_join(
    pivot_longer(data.frame(aic),cols = names(reg_models),names_to ="modelrdm",values_to = "AIC"),
    pivot_longer(data.frame(bic),cols = names(reg_models),names_to ="modelrdm",values_to = "BIC")
  )
  
  reg_res_df = left_join(rsquardf,icdf)

  df = cbind(reg_res_df, reg_df[j,][rep(1,nrow(reg_res_df)),])
  return(df)
})
stopCluster(cl)
```



```{r}
reg_rdm_df = do.call(rbind,reg_res)%>%
  mutate(islearner = factor(islearner,levels = c(0,1),labels = c("non-learner","learner")),
         isgeneralizer = factor(isgeneralizer,levels = c(0,1),labels = c("non-generalizer","generalizer")))

colnames(reg_rdm_df)
reg_rdm_df_agg = 
  aggregate_data(reg_rdm_df,
     yvars= c("Rsquare","adjustedRsquare","AIC","BIC"),
     groupbyvars = c("islearner","isgeneralizer","stage",
                     "blocknumber_withinsess","modelrdm"),
     stats = c("mu","se","n"),
     additionalvars = c("session_str")
  )

reg_rdm_df%>%
  #filter(islearner=="learner",isgeneralizer=="generalizer")%>%
  filter(!grepl("separate",modelrdm))%>%
ggplot(data=,
       aes(x=blocknumber_withinsess,color=modelrdm,group=subid))+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free_x",space = "free_x")+
  geom_point(aes(y=adjustedRsquare,
                color=modelrdm),alpha=.3,position=position_dodge(width=1))+
  #geom_errorbar(aes(ymin = mu_adjustedRsquare - se_adjustedRsquare,
            #        ymax = mu_adjustedRsquare + se_adjustedRsquare),
            #    width=0.4)+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="mean adjustedRsquare",color = "model rdm",
       title = "performance of learners and generalizers")+
  theme(aspect.ratio = 6,legend.position = "top")
```



```{r}
reg_rdm_subset = reg_rdm_df%>%
  filter(grepl("separate",modelrdm))
reg_rdm_wide=
reg_rdm_subset%>%
  pivot_wider(id_cols=c(subid,islearner,isgeneralizer,
                        stage,session_str,blocknumber_withinsess),
              values_from = c(AIC,BIC,adjustedRsquare,Rsquare),
              names_from = modelrdm)
mfit_cols = list(
  AIC = lapply(unique(reg_rdm_subset["modelrdm"]),function(x) {paste("AIC",x,sep="_")})$modelrdm,
  BIC = lapply(unique(reg_rdm_subset["modelrdm"]),function(x) {paste("BIC",x,sep="_")})$modelrdm,
  Rsquare = lapply(unique(reg_rdm_subset["modelrdm"]),function(x) {paste("Rsquare",x,sep="_")})$modelrdm,
  adjustedRsquare = lapply(unique(reg_rdm_subset["modelrdm"]),function(x) {paste("adjustedRsquare",x,sep="_")})$modelrdm
)
reg_rdm_wide=reg_rdm_wide%>%
  mutate(
    winning_AIC = substring(
      mfit_cols$AIC[max.col(-reg_rdm_wide[,mfit_cols$AIC],"first")],5),
    winning_BIC = substring(
      mfit_cols$BIC[max.col(-reg_rdm_wide[,mfit_cols$BIC],"first")],5),
    winning_Rsquare = substring(
      mfit_cols$Rsquare[max.col(reg_rdm_wide[,mfit_cols$Rsquare],"first")],9),
    winning_adjustedRsquare = substring(
      mfit_cols$adjustedRsquare[max.col(reg_rdm_wide[,mfit_cols$adjustedRsquare],"first")],17),)
reg_rdm_winning = reg_rdm_wide%>%
  dplyr::select(-c(starts_with("AIC"),starts_with("BIC"),
                   starts_with("adjustedRsquare"),starts_with("Rsquare")))%>%
  pivot_longer(cols = c(winning_AIC,winning_BIC,winning_Rsquare,winning_adjustedRsquare),
               names_to ="criteria",values_to = "modelrdm")

reg_rdm_winning_agg = 
  aggregate_data(reg_rdm_winning,
     yvars= c("subid"),
     groupbyvars = c("islearner","isgeneralizer","stage","session_str","criteria",
                     "blocknumber_withinsess","modelrdm"),
     stats = c("n")
  )%>%
  change_cols_name(oldnames="n_subid",newnames = "n_sub")

reg_rdm_winning_agg%>%
  #filter(islearner=="learner",isgeneralizer=="generalizer")%>%#
  filter(criteria=="winning_adjustedRsquare")%>%
  ggplot(aes(x=blocknumber_withinsess,y=n_sub,fill=modelrdm))+
  facet_nested(cols =vars(stage,session_str),
               rows = vars(islearner,isgeneralizer),
               scales = "free",space = "free_x")+
  geom_col(position="stack")+
  scale_x_continuous(breaks = seq(1,12,1))+
  labs(x="block number",y="number of participants",color = "model rdm",
       title = "winning model rdm")+
  theme(aspect.ratio = 6,legend.position = "top")
```

