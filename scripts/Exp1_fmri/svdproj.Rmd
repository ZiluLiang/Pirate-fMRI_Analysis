---
title: "fMRIdimensionalityprojection"
output: html_document
date: "2025-06-06"
---

```{r setup, include=FALSE}

rm(list = ls())
knitr::opts_chunk$set(error = FALSE,echo=FALSE, message=FALSE, warning=FALSE,fig.width = 11,fig.height = 6)

rm(list = ls())
project_dir = rstudioapi::getActiveProject();
src_dir = file.path(project_dir, "src/R", fsep="/")
llr_dir = file.path(project_dir, "src/LLR", fsep="/")

data_dir = file.path(project_dir,"data","Exp1_fmri","fmri","ROIdata","cvSVD_dimsionality", fsep="/")
result_dir = data_dir


source(file.path(src_dir,"envSetup.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"funcDef.R",fsep="/"), local = knitr::knit_global())
source(file.path(src_dir,"setPlotDefault.R",fsep="/"), local = knitr::knit_global())
source(file.path(project_dir,"scripts","Exp1_fmri","plotting_colorpals.R"))

scaled_projection_df = read.csv(file.path(data_dir,"trainingstim_withinax_meanXsvd1Dproj_df.csv")) 
```

## Prepdata

```{r}
scaled_projection_df = scaled_projection_df%>%
  mutate(axisloc_factor = factor(axisloc*2,levels=c(-2,-1,1,2),
                       ordered=TRUE)
         )
```


## LME
```{r}
lmerfml = "SVD_projection~axisloc*dimonaxis+(1|subid)"
```

```{r}
ppc_res = lmer(data=filter(scaled_projection_df,roi=="PPC_bilateral"&subgroup=="Generalizer"), lmerfml)

isSingular(ppc_res)
summary(ppc_res)
summary(emtrends(ppc_res, var = "axisloc", specs = "dimonaxis"),infer=T)

```

```{r}
v1_res = lmer(data=filter(scaled_projection_df,roi=="V1_bilateral"&subgroup=="Generalizer"), lmerfml)

summary(v1_res)
summary(emtrends(v1_res, var = "axisloc", specs = "dimonaxis"),infer=T)

```

```{r}
hpc_res = lmer(data=filter(scaled_projection_df,roi=="HPC_bilateral"&subgroup=="Generalizer"), lmerfml)

summary(hpc_res)
summary(emtrends(hpc_res, var = "axisloc", specs = "dimonaxis"),infer=T)

```


```{r}
vmpfc_res = lmer(data=filter(scaled_projection_df,roi=="vmPFC_bilateral"&subgroup=="Generalizer"), lmerfml)

summary(vmpfc_res)
summary(emtrends(vmpfc_res, var = "axisloc", specs = "dimonaxis"),infer=T)

```




```{r}
fp = file.path(result_dir,"svd1Dprojection_MLE.xlsx")
export_summs(v1_res,ppc_res,hpc_res,vmpfc_res,
             model.names = c("EVC","PPC","HPC","vmPFC"),
             error_format = "[{conf.low}, {conf.high}]",
             to.file="xlsx",
             file.name = fp)




# Install if not already
library(openxlsx)

if (file.exists(fp)) {
  wb <- loadWorkbook(fp)
} else {
  wb <- createWorkbook()
}

# Combine all summaries into a named list
sheets <- list(
  v1 = summary(emtrends(v1_res, var = "axisloc", specs = "dimonaxis"), infer = TRUE),
  PPC = summary(emtrends(ppc_res, var = "axisloc", specs = "dimonaxis"), infer = TRUE),
  HPC = summary(emtrends(hpc_res, var = "axisloc", specs = "dimonaxis"), infer = TRUE),
  vmPFC = summary(emtrends(vmpfc_res, var = "axisloc", specs = "dimonaxis"), infer = TRUE)
)

# Add each sheet to the workbook
for (sheet_name in names(sheets)) {
  # Make sure the sheet name is unique (remove if already exists)
  if (sheet_name %in% names(wb)) {
    removeWorksheet(wb, sheet_name)
  }
  addWorksheet(wb, sheet_name)
  writeData(wb, sheet = sheet_name, sheets[[sheet_name]])
}

# Save the updated workbook
saveWorkbook(wb, file = fp, overwrite = TRUE)

```




